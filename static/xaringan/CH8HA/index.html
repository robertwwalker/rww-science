<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Time Series: Exponential Smoothing</title>
    <meta charset="utf-8" />
    <meta name="author" content="Robert W. Walker" />
    <meta name="date" content="2021-03-05" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Time Series: Exponential Smoothing
## FPP3, Chapter 8
### Robert W. Walker
### AGSM
### 2021-03-05

---






# An Overview

Expanding the space of relevant models still operates in the circle of chapter 5.

![Forecasting Diagram](img/Workflow.PNG)

---
### An Overview

Expanding the space of relevant models still operates in the circle of chapter 5.

+ Linear Models: tidying up  
+ Univariate 1: **Exponential Smoothing**
+ Univariate 2: ARIMA models
+ Dynamic Regression [Tying it Together]

![Forecasting Diagram](img/Workflow.PNG)


---
### A Bit More on Linear Models

Nonlinearity; they argue against nonlinear trends.  So now what?  Knots.  Trends are not always *monotonic*.  Witness the example of population in Afghanistan.  **NB: But this probably gets unrealistic pretty fast.**


```r
global_economy %&gt;%
  filter(Country == "Afghanistan") %&gt;%
  autoplot(Population / 1e6) +
  labs(y = "Population (millions)") +
  geom_ribbon(aes(xmin = 1979.98, xmax = 1989.13), fill = "pink", alpha = 0.4) +
  annotate("text", x = 1984.5, y = 10, label = "Soviet-Afghan war", col = "red", size = 3)
```

---

&lt;img src="index_files/figure-html/unnamed-chunk-2-1.png" width="576" /&gt;


---
# Compare


```r
fit &lt;- global_economy %&gt;%
  filter(Country == "Afghanistan") %&gt;%
  model(
    linear = TSLM(Population ~ trend()),
    piecewise = TSLM(Population ~ trend(knots = c(1980, 1989)))
  )
fit %&gt;% report()
```

---
# Compare


```
# A tibble: 2 x 16
  Country     .model    r_squared adj_r_squared  sigma2 statistic
  &lt;fct&gt;       &lt;chr&gt;         &lt;dbl&gt;         &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
1 Afghanistan linear        0.838         0.835 1.02e13      290.
2 Afghanistan piecewise     0.999         0.999 9.05e10    12929.
# â€¦ with 10 more variables: p_value &lt;dbl&gt;, df &lt;int&gt;,
#   log_lik &lt;dbl&gt;, AIC &lt;dbl&gt;, AICc &lt;dbl&gt;, BIC &lt;dbl&gt;, CV &lt;dbl&gt;,
#   deviance &lt;dbl&gt;, df.residual &lt;int&gt;, rank &lt;int&gt;
```

---
# Residual Assessment

&lt;img src="index_files/figure-html/unnamed-chunk-5-1.png" width="576" /&gt;

---
# Residual Assessment

&lt;img src="index_files/figure-html/unnamed-chunk-6-1.png" width="576" /&gt;


---
# Fit Assessment

&lt;img src="index_files/figure-html/unnamed-chunk-7-1.png" width="576" /&gt;



---
# Forecasts?


```r
fc &lt;- fit %&gt;% forecast(h = "5 years")
autoplot(fc) +
  autolayer(filter(global_economy %&gt;% filter(Country == "Afghanistan")), Population)
```

&lt;img src="index_files/figure-html/unnamed-chunk-8-1.png" width="576" /&gt;


---

## Packages

Getting started

```
library(tidyverse)
library(fpp3)
library(purrr)
library(gganimate)
library(seasonal)
library(tidyquant)
library(magrittr)
```
---

# The magic of `forecast`

The method:
1. Tidy  
2. Visualise  
3. Model  
  a. Specify  
  b. Estimate  
  c. Evaluate  
  d. Visualize  
4. Forecast

---

# Models

```
3. Model  
  a. Specify  
  b. Estimate  
  c. Evaluate  
  d. Visualize  
```

---
# Last Time: The Linear Model

`$$y_{t} = \beta_{0} + \beta_{1}x_{t} + \epsilon_{t}$$`

---
### Strengths and Limitations

Strengths:
+ Trends can be linear or nonlinear [knots].  
+ Seasonality can be naturally accommodated.  
+ Can accommodate covariates and lag structures.

Weaknesses:
+ Persistence of unknown origin and the need for decay.  This will be inherently nonlinear.

---
## Simple Exponential Smoothing

Appropriate for absence of seasons and trends.  We could use **naive** (most recent observation receives all the weight, `\(\alpha=1\)`) and **average** (all values equally weighted, `\(\alpha=0\)`) methods for such data.  Simple exponential smoothing occupies the space between with parameter `\(\alpha\)` such that

`$$\hat{y}_{T+1|T} = \alpha y_{T} + \alpha(1 - \alpha)y_{T-1} + \alpha(1-\alpha)^{2}y_{T-2} + \ldots + \alpha(1-\alpha)^{k}y_{T-k}$$`

---
## Weighted Averages and the Component Form

Describe the outcome as two separate but combineable forms: a Forecast equation `$$\hat{y}_{t+h|t} = S_{t}$$` and a Smoothing Equation `$$S_{t} = \alpha y_{t} + (1-\alpha) S_{t-1}$$`.

If we combine them, we get:

`$$\hat{y}_{t+h|t} = \alpha y_{t} + (1-\alpha) S_{t-1}$$`

---

## The Model: `ETS`

the `error` component (either `M` multiplicative or `A` additive)

the `trend`

the `season`

Some comments on options -- the optimization method.

---

# Holt's Trends

Describe the outcome as three separate but combinable forms: 
a Forecast equation `$$\hat{y}_{t+h|t} = S_{t} + hb_{t}$$` 

a Level Equation `$$S_{t} = \alpha y_{t} + (1-\alpha)(S_{t-1} + b_{t-1})$$` and 
a trend equation `$$b_{t} = \beta^{*}(S_{t} - S_{t-1}) + (1-\beta^{*})b_{t-1}$$`.

If we combine them, we get:

`$$\hat{y}_{t+h|t} = \alpha y_{t} + (1-\alpha)(S_{t-1} + b_{t-1}) + h(\beta^{*}(S_{t} - S_{t-1}) + (1-\beta^{*})b_{t-1})$$`

---
## Damping

Flatten the trend into the future.  Expand Holt's trend model with an additional damping parameter -- `\(\phi\)`.  

`$$\hat{y}_{t+h|t} = S_{t} + (\phi + \phi^2 + \ldots + \phi^{h})b_{t}$$` 

`$$S_{t} = \alpha y_{t} + (1-\alpha)(S_{t-1} + \phi b_{t-1})$$`

`$$b_{t} = \beta^{*}(S_{t} - S_{t-1}) + (1-\beta^{*})\phi b_{t-1}$$`

---
## The Holt-Winters Method(s)

Describe the outcome as three separate but [additively] combinable forms: 
a Forecast equation `$$\hat{y}_{t+h|t} = S_{t} + hb_{t} + s_{t + h - m(k+1)}$$` 

a Level Equation `$$S_{t} = \alpha(y_{t} - s_{t-m} + (1-\alpha)(S_{t-1} + b_{t-1})$$`
a trend equation `$$b_{t} = \beta^{*}(S_{t} - S_{t-1}) + (1-\beta^{*})b_{t-1}$$`
and a seasonal equation `$$s_{t} = \gamma(y_{t} - S_{t-1} - b_{t-1}) + (1-\gamma)s_{t-m}$$`.

---
# Multiplicative?

![Holt-Winters](img/HWMult.jpg)
---
## Damping

[Add the damping terms in the trend to the previous:](https://otexts.com/fpp3/holt-winters.html)

![HW-Damp](img/HWMultDamp.jpg)

---
## A Taxonomy [and the code]

A [glorious taxonomy](https://otexts.com/fpp3/taxonomy.html) for the models that all fits in one simple code expression.

```
model(ETS(outcome ~ error("A"/"M") 
+ trend(method=c("N","A","Ad")) 
+ season(method = c("N", "A", "M"))))
```

---
## Model Selection and IC [and Caveats]

NB: Multiplicative errors and negative values  [also, next slide]

Information criterion [IC] provide a measure of goodness of fit for models that may differ in number of parameters or underlying form.  Minimize it.  

`ETS` will do this automagically if not given guidance.


```r
aus_busines &lt;- tourism %&gt;%
    filter(Purpose == "Business") %&gt;%
    summarise(Trips = sum(Trips)/1e3)
fit &lt;- aus_busines %&gt;%
    model(ETS(Trips))
report(fit)
```

---
# Result


```
Series: Trips 
Model: ETS(M,N,A) 
  Smoothing parameters:
    alpha = 0.4732817 
    gamma = 0.0001000058 

  Initial states:
        l         s1        s2         s3         s4
 3.959449 0.07274141 0.3903185 0.09830194 -0.5613619

  sigma^2:  0.0057

     AIC     AICc      BIC 
163.7094 165.2649 180.3836 
```


---
# What does it look like?


```r
components(fit) %&gt;%
  autoplot() +
  labs(title = "ETS(M,N,A) components")
```

&lt;img src="index_files/figure-html/unnamed-chunk-11-1.png" width="576" /&gt;

---
## Innovations and Residuals [Multiplicative]


```r
fit %&gt;% augment() %&gt;% select(.innov,.resid) %&gt;% pivot_longer(c(.innov,.resid)) %&gt;% autoplot()
```

&lt;img src="index_files/figure-html/unnamed-chunk-12-1.png" width="576" /&gt;


---
## Forecast Variances

Not all are known analytically, but we can always use distributions of step ahead paths to simulate and summarise them.


---
# A Simplified Example


```r
load("USEmployment.RData")
us_employment %&gt;% data.frame() %&gt;% group_by(Series_ID) %&gt;% summarise(Title = first(Title)) %&gt;% mutate(series_id = Series_ID) %&gt;% ungroup() %&gt;% select(-Series_ID) -&gt; Names.List
US.Employment.T &lt;- left_join(US.Employment, Names.List, by = c("series_id" = "series_id")) %&gt;% mutate(YM = yearmonth(date)) %&gt;% rename(Employed = value) %&gt;% as_tsibble(., index=YM, key=Title)
USET &lt;- US.Employment.T %&gt;% filter(YM &gt; yearmonth("1990-01"), Title%in%c("Retail Trade")) %&gt;% as_tsibble(., index=YM, key=Title)
USEM &lt;- US.Employment.T %&gt;% filter(YM &gt; yearmonth("1990-01"), Title%in%c("Manufacturing")) %&gt;% as_tsibble(., index=YM, key=Title)
```

---
# A Model


```r
USETS &lt;- USET %&gt;% model(ETS(Employed))
USETS %&gt;% report()
```

```
Series: Employed 
Model: ETS(M,N,A) 
  Smoothing parameters:
    alpha = 0.967599 
    gamma = 0.000100245 

  Initial states:
        l        s1       s2       s3       s4        s5
 13431.53 -61.05507 587.4126 408.7336 40.73423 -87.14542
        s6        s7        s8        s9       s10       s11
 -9.647193 -12.55176 -21.01246 -124.4436 -228.6283 -233.3413
       s12
 -259.0552

  sigma^2:  0.0001

     AIC     AICc      BIC 
5858.173 5859.521 5916.956 
```

---
# `augment`


```r
augment(USETS) %&gt;% select(.innov,.resid) %&gt;% pivot_longer(c(.innov,.resid)) %&gt;% autoplot()
```

&lt;img src="index_files/figure-html/unnamed-chunk-15-1.png" width="576" /&gt;

---
## The residual


```r
USETS %&gt;% gg_tsresiduals()
```

&lt;img src="index_files/figure-html/unnamed-chunk-16-1.png" width="576" /&gt;

---
## They don't always end up MNA


```r
USETSM &lt;- USEM %&gt;% model(ETS(Employed))
USETSM %&gt;% report()
```

```
Series: Employed 
Model: ETS(A,Ad,A) 
  Smoothing parameters:
    alpha = 0.8357814 
    beta  = 0.1581301 
    gamma = 0.1634883 
    phi   = 0.911447 

  Initial states:
        l         b        s1       s2       s3       s4       s5
 17935.55 -45.87953 -104.5277 15.24663 31.31771 51.40015 80.23824
       s6       s7       s8        s9       s10       s11
 92.18335 20.34779 83.99983 -35.97472 -69.76497 -67.62791
       s12
 -96.83835

  sigma^2:  7755.833

     AIC     AICc      BIC 
5552.134 5554.072 5622.674 
```

---


```r
USETSM %&gt;% augment() %&gt;% select(Employed,.fitted) %&gt;% pivot_longer(c(Employed,.fitted)) %&gt;% autoplot()
```

&lt;img src="index_files/figure-html/unnamed-chunk-18-1.png" width="576" /&gt;


---
# Diagnostics for residuals

Seek to falsify two desirable characteristics:

1. Residuals should be uncorrelated [remaining time series information] 
2. Residuals should have mean zero [otherwise bias -- systematically wrong].

Additional desiderata include: Constant variance and normalcy though the latter implies the former.

---

## Correlation and Causation

ARE NOT THE SAME.

---
# The essential workflow

[It all goes back to chapter 5](https://otexts.com/fpp3/a-tidy-forecasting-workflow.html).
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
