---
title: COVID-19 in Oregon
author: Robert W. Walker
date: '2020-03-24'
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>


<div id="oregon-covid-data" class="section level1">
<h1>Oregon COVID data</h1>
<p>In this post, I want to visualize the data on COVID-19 in the state of Oregon. I now have a few days of data that I want to scrape, separate, clean up, and plot. The process of scraping it is detailed in <a href="https://rww.science/r/covid-scraping/">a separate file</a>. These data are current as of March 26, 2020.</p>
<pre class="r"><code>load(url(paste0(&quot;https://rww.science/r/covid/data/OregonCOVID&quot;,Sys.Date(),&quot;.RData&quot;)))</code></pre>
<p>These data are current as of 2020-03-26.</p>
<div id="building-a-base-map" class="section level2">
<h2>Building a base map</h2>
<p>To build a map to work from, I need a map library. Load the <code>tigris</code> library then grab the map as an <code>sf</code> object; there is a <code>geom_sf</code> that makes them easy to work with. Finally, I join the map to the data.</p>
<pre class="r"><code>library(tigris); library(rgdal); library(htmltools); library(viridis); library(sf); library(viridis)
counties.t &lt;- counties(state = &quot;41&quot;, resolution = &quot;500k&quot;, class=&quot;sf&quot;)
Map.Me &lt;- left_join(counties.t,Oregon.COVID, by=c(&quot;NAME&quot; = &quot;County&quot;))</code></pre>
</div>
</div>
<div id="the-whole-thing-an-animation" class="section level1">
<h1>The Whole Thing: An Animation</h1>
<p>I will use a ggplot to build Oregonâ€™s map and fill it with case numbers. <code>geom_sf()</code> plots the geometry. I have to repel the labels to prevent print overlap, and scheme the colors. The last step is to animate it by time. If I stop the label repelling, they will not bounce but it adds excitement.</p>
<pre class="r"><code>library(ggrepel); library(ggthemes); library(gganimate)
library(patchwork); library(hrbrthemes)
Anim1 &lt;- Map.Me %&gt;% 
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME, group=NAME)) + 
  geom_sf() +
  geom_label_repel(stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    colour = &quot;white&quot;,
    segment.colour = &quot;white&quot;,
    size = 3,
    box.padding = unit(0.05, &quot;lines&quot;))  + scale_fill_continuous_tableau(&quot;Red&quot;) + theme_minimal() + labs(title=&quot;COVID-19 in Oregon&quot;, subtitle=&quot;{frame_time}&quot;, x=&quot;&quot;, y=&quot;&quot;, caption=&quot;Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19&quot;) + transition_time(date)
ResA &lt;- animate(Anim1, end_pause=100, nframes=200)
ResA</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-3-1.gif" /><!-- --></p>
</div>
<div id="some-data-on-testing" class="section level1">
<h1>Some Data on Testing</h1>
<p>What is the status of testing?</p>
<pre class="r"><code>OR.Testing &lt;- Oregon.Tests %&gt;% group_by(date) %&gt;% summarise(Total = sum(Outcome))
Test1 &lt;- Oregon.Tests %&gt;% ggplot(.) + aes(x=date, y=Outcome, fill=Category, label=Outcome) + geom_col() + geom_label(col=&quot;magenta&quot;, show.legend = FALSE) + scale_fill_viridis_d() + labs(title=&quot;COVID-19 Testing in Oregon&quot;, y=&quot;Tests&quot;, x=&quot;Date&quot;, subtitle=&quot;Total shown as label&quot;, caption = &quot;data: https://govstatus.egov.com/OR-OHA-COVID-19&quot;) + geom_label(data=OR.Testing, aes(x=date, y=Total+100, label=Total), fill=&quot;white&quot;, color=&quot;black&quot;, inherit.aes = FALSE)
Test1</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
<div id="a-second-look-at-testing" class="section level1">
<h1>A Second Look at Testing</h1>
<p>We should worry about the degree to which tests are applied at all randomly; they are surely not. As a result, what it means to calculate or break down probability based on having been tested is subject to so many important caveats that vary over time. It is important to note that this is also cumulative.</p>
<pre class="r"><code>Test2 &lt;- Oregon.Tests %&gt;% ggplot(.) + aes(x=date, y=Outcome, fill=Category, label=Outcome) + geom_col(position = &quot;fill&quot;) + scale_fill_viridis_d() + labs(title=&quot;COVID-19 Testing in Oregon&quot;, y=&quot;Proportion of Tests&quot;, x=&quot;Date&quot;, caption = &quot;data: https://govstatus.egov.com/OR-OHA-COVID-19&quot;)
Test2</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<div id="a-better-look-at-this" class="section level2">
<h2>A Better Look at This</h2>
<pre class="r"><code>MyDat &lt;- Oregon.Tests %&gt;% 
  pivot_wider(., names_from = Category, values_from = Outcome) %&gt;% 
  mutate(Positive.Chg = Positive - lag(Positive, order_by = date), 
         Negative.Chg = Negative - lag(Negative, order_by = date)) %&gt;% 
  mutate(Total = Positive.Chg + Negative.Chg) %&gt;% 
  mutate(Positive.Pct = round(Positive.Chg / Total, digits=3)) %&gt;% 
  select(date, Positive.Chg, Negative.Chg, Positive.Pct) %&gt;% 
  pivot_longer(., c(Negative.Chg, Positive.Chg), names_to = &quot;Outcome&quot;, values_to = &quot;Test.Changes&quot;)
MyDat %&gt;% ggplot(., aes(x=date, y=Test.Changes, fill=Outcome)) + geom_col(position=&quot;fill&quot;) + geom_label(data=MyDat, aes(x=date, y=Positive.Pct, label=Positive.Pct), inherit.aes = TRUE, show.legend=FALSE) + scale_fill_ipsum() + labs(title=&quot;Daily Distribution of Test Outcomes&quot;, subtitle=&quot;Percent of Positive Tests Shown&quot;)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<div id="hospitalization-data" class="section level1">
<h1>Hospitalization Data</h1>
<p>How do positive cases and hospitalization relate?</p>
<pre class="r"><code>Hos1 &lt;- OR.Hosp %&gt;% filter(Hospitalized.!=&quot;Total&quot;) %&gt;% ggplot(., aes(x=date, y=Number.of.cases,fill=Hospitalized.)) + geom_col() + scale_fill_ipsum() + labs(x=&quot;Date&quot;, y=&quot;Number of COVID Positives&quot;, fill=&quot;Hospitalized?&quot;, title=&quot;Hospitalization Status of COVID-19 Positives in Oregon&quot;)
Hos2 &lt;- OR.Hosp %&gt;% filter(Hospitalized.!=&quot;Total&quot;) %&gt;% ggplot(., aes(x=date, y=Number.of.cases,fill=Hospitalized.)) + geom_col(position=&quot;fill&quot;) + scale_fill_ipsum() + labs(x=&quot;Date&quot;, y=&quot;Number of COVID Positives&quot;, fill=&quot;Hospitalized?&quot;, title=&quot;Hospitalization Status of COVID-19 Positives in Oregon&quot;)
Hos1 + Hos2</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="age-data" class="section level1">
<h1>Age Data</h1>
<p>How does this break down by age? <em>I had to break this into two parts. They changed the classification method on March 25, 2020.</em></p>
<pre class="r"><code>OR.Ages1 &lt;- OR.Ages %&gt;% filter(date &lt; &quot;2020-03-25&quot;)
Age1 &lt;- OR.Ages1 %&gt;% ggplot(., aes(x=date, y=Number.of.cases, fill=Age.group)) + geom_col() + scale_fill_ipsum() + labs(x=&quot;Date&quot;, y=&quot;Number of COVID-19 Positives&quot;) + theme_economist() + guides(fill=FALSE)
Age2 &lt;- OR.Ages1 %&gt;% ggplot(.) +
 aes(x = date, fill = Age.group, weight = Number.of.cases) +
 geom_bar(position = &quot;fill&quot;) +
 scale_fill_ipsum() + labs(x=&quot;Date&quot;, y=&quot;Proportion of COVID-19 Positives&quot;) +
 theme_minimal()
Age1 + Age2</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div id="the-revision" class="section level3">
<h3>The Revision</h3>
<pre class="r"><code>OR.Ages1 &lt;- OR.Ages %&gt;% filter(date &gt; &quot;2020-03-24&quot;)
Age1 &lt;- OR.Ages1 %&gt;% ggplot(., aes(x=date, y=Number.of.cases, fill=Age.group)) + geom_col() + scale_fill_viridis(discrete = TRUE) + labs(x=&quot;Date&quot;, y=&quot;Number of COVID-19 Positives&quot;) + theme_economist() + guides(fill=FALSE)
Age2 &lt;- OR.Ages1 %&gt;% ggplot(.) +
 aes(x = date, fill = Age.group, weight = Number.of.cases) +
 geom_bar(position = &quot;fill&quot;) +
 scale_fill_viridis(discrete=TRUE) + labs(x=&quot;Date&quot;, y=&quot;Percent of COVID-19 Positives&quot;) +
 theme_minimal()
Age1 + Age2</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="some-gender-data" class="section level2">
<h2>Some Gender Data</h2>
</div>
<div id="hospital-capacity-data" class="section level2">
<h2>Hospital Capacity Data</h2>
</div>
<div id="a-mapping-function" class="section level2">
<h2>A Mapping Function</h2>
<p>To save time later, I turned the plots into a function so that I can use to reproduce each frame. Two inputs to the function, the dataset that is always the merged data from above and the date that I want to plot located in <code>date1</code> in a <code>YYYY-MM-DD</code> format.</p>
<pre class="r"><code>Plot.COVID &lt;- function(date1, data) {
data %&gt;% filter(date==date1) %&gt;%
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME)) + 
  geom_sf() +
  geom_label_repel(stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    colour = &quot;white&quot;,
    segment.colour = &quot;white&quot;,
    size = 3,
    box.padding = unit(0.05, &quot;lines&quot;))  + scale_fill_continuous_tableau(&quot;Red&quot;) + theme_minimal() + labs(title=&quot;COVID-19 in Oregon&quot;, subtitle=date1, x=&quot;&quot;, y=&quot;&quot;, caption=&quot;Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19&quot;)
}</code></pre>
</div>
<div id="the-result-for-03182020" class="section level2">
<h2>The Result for 03/18/2020</h2>
<p>This is the first date for which I can find data. The <code>waybackmachine</code> was crucial.</p>
<pre class="r"><code>Plot.COVID(&quot;2020-03-18&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="the-result-for-03192020" class="section level2">
<h2>The Result for 03/19/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-19&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
</div>
<div id="the-result-for-03202020" class="section level2">
<h2>The Result for 03/20/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-20&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
</div>
<div id="the-result-for-03212020" class="section level2">
<h2>The Result for 03/21/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-21&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
</div>
<div id="the-result-for-03222020" class="section level2">
<h2>The Result for 03/22/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-22&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
<div id="the-result-for-03232020" class="section level2">
<h2>The Result for 03/23/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-23&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
</div>
<div id="the-result-for-03242020" class="section level2">
<h2>The Result for 03/24/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-24&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
</div>
<div id="the-result-for-03252020" class="section level2">
<h2>The Result for 03/25/2020</h2>
<pre class="r"><code>Plot.COVID(&quot;2020-03-25&quot;, Map.Me)</code></pre>
<p><img src="/R/COVID/index_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
</div>
<div id="the-result-for-03262020" class="section level2">
<h2>The Result for 03/26/2020</h2>
<pre class="r"><code>library(plotly); library(widgetframe); library(ggthemes); library(RColorBrewer)
Map.Me &lt;- Map.Me %&gt;% mutate(TTip = paste0(&quot;Deaths: &quot;,Deaths,&quot;&lt;br&gt; Negative Tests:&quot;,Negative.test.results))
Res.1 &lt;- Map.Me %&gt;% filter(date==Sys.Date()) %&gt;%
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME, text=TTip)) + 
  geom_sf() + 
  scale_fill_viridis_c(option = &quot;A&quot;) + 
  theme_map() + 
  labs(title=&quot;COVID-19 in Oregon&quot;, subtitle=Sys.Date(), x=&quot;&quot;, y=&quot;&quot;, caption=&quot;Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19&quot;, fill=&quot;COVID-19 Cases&quot;)
ggp &lt;- ggplotly(Res.1)
frameWidget(ggp)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:480px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/R/COVID/index_files/figure-html//widgets/widget_unnamed-chunk-19.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
