---
title: COVID-19 in Oregon
author: Robert W. Walker
date: '2020-03-24'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)
library(tidyverse)
```

# Oregon COVID data

In this post, I want to visualize the data on COVID-19 in the state of Oregon.  I now have a few days of data that I want to scrape, separate, clean up, and plot.  The process of scraping it is detailed in [a separate file](https://rww.science/r/covid/scraping/).  These data are current as of March 24, 2020.

```{r}
load(url("https://rww.science/2020/03/24/covid-19-county-maps-for-oregon/data/OregonCOVID2020-03-24.RData"))
```

## Building a base map

To build a map to work from, I need a map library.  Load the `tigris` library then grab the map as an `sf` object; there is a `geom_sf` that makes them easy to work with.  Finally, I join the map to the data.

```{r, message=FALSE, warning=FALSE, results='hide'}
library(tigris); library(rgdal); library(htmltools); library(viridis); library(sf); library(viridis)
counties.t <- counties(state = "41", resolution = "500k", class="sf")
Map.Me <- left_join(counties.t,Oregon.COVID, by=c("NAME" = "County"))
```

# The Whole Thing: An Animation

I will use a ggplot to build Oregon's map and fill it with case numbers.  `geom_sf()` plots the geometry.  I have to repel the labels to prevent print overlap, and scheme the colors.  The last step is to animate it by time.

```{r}
library(ggrepel); library(ggthemes); library(gganimate)
Anim1 <- Map.Me %>% 
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME, group=NAME)) + 
  geom_sf() +
  geom_label_repel(stat = "sf_coordinates",
    min.segment.length = 0,
    colour = "white",
    segment.colour = "white",
    size = 3,
    box.padding = unit(0.05, "lines"))  + scale_fill_continuous_tableau("Red") + theme_minimal() + labs(title="COVID-19 in Oregon", subtitle="{frame_time}", x="", y="", caption="Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19") + transition_time(date)
ResA <- animate(Anim1, end_pause=100, nframes=200)
ResA
```

# Some Data on Testing

What is the status of testing?

```{r}
OR.Testing <- Oregon.Tests %>% group_by(date) %>% summarise(Total = sum(Outcome))
Test1 <- Oregon.Tests %>% ggplot(.) + aes(x=date, y=Outcome, fill=Category, label=Outcome) + geom_col() + geom_label(col="magenta") + scale_fill_viridis_d() + labs(title="COVID-19 Testing in Oregon", y="Tests", subtitle="Total shown as label", caption = "data: https://govstatus.egov.com/OR-OHA-COVID-19") + geom_label(data=OR.Testing, aes(x=date, y=Total+100, label=Total), fill="white", color="black", inherit.aes = FALSE)
Test1
```

# Hospitalization Data

How do positive cases and hospitalization relate?

```{r}
Hos1 <- OR.Hosp %>% filter(Hospitalized.!="Total") %>% ggplot(., aes(x=date, y=Number.of.cases,fill=Hospitalized.)) + geom_col() + scale_fill_viridis_d() + labs(x="Date", y="Number of COVID Positives", fill="Hospitalized?", title="Hospitalization Status of COVID-19 Positives in Oregon")
Hos1
```

# Age Data

How does this break down by age?

```{r}
Age1 <- OR.Ages %>% ggplot(., aes(x=date, y=Number.of.cases, fill=Age.group)) + geom_col() + scale_fill_viridis_d() + labs(x="Date", y="Number of COVID-19 Positives")
Age1
```


## A Mapping Function

To save time later, I turned the plots into a function so that I can use to reproduce each frame.  Two inputs to the function, the dataset that is always the merged data from above and the date that I want to plot located in `date1` in a `YYYY-MM-DD` format.

```{r}
Plot.COVID <- function(date1, data) {
data %>% filter(date==date1) %>%
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME)) + 
  geom_sf() +
  geom_label_repel(stat = "sf_coordinates",
    min.segment.length = 0,
    colour = "white",
    segment.colour = "white",
    size = 3,
    box.padding = unit(0.05, "lines"))  + scale_fill_continuous_tableau("Red") + theme_minimal() + labs(title="COVID-19 in Oregon", subtitle=date1, x="", y="", caption="Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19")
}
```

## The Result for 03/18/2020

This is the first date for which I can find data.  The `waybackmachine` was crucial.

```{r}
Plot.COVID("2020-03-18", Map.Me)
```


## The Result for 03/19/2020

```{r}
Plot.COVID("2020-03-19", Map.Me)
```


## The Result for 03/20/2020

```{r}
Plot.COVID("2020-03-20", Map.Me)
```


## The Result for 03/21/2020

```{r}
Plot.COVID("2020-03-21", Map.Me)
```

## The Result for 03/22/2020

```{r}
Plot.COVID("2020-03-22", Map.Me)
```


## The Result for 03/23/2020

```{r}
Plot.COVID("2020-03-23", Map.Me)
```

## The Result for 03/24/2020

```{r}
Plot.COVID("2020-03-23", Map.Me)
```
