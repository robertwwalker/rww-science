---
title: COVID-19 in Oregon
author: Robert W. Walker
date: '2020-03-24'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)
library(tidyverse)
```

# Oregon COVID data

In this post, I want to visualize the data on COVID-19 in the state of Oregon.  I now have a few days of data that I want to scrape, separate, clean up, and plot.  The process of scraping it is detailed in [a separate file](https://rww.science/r/covid-scraping/).  These data are current as of March 26, 2020.

```{r}
load(url(paste0("https://rww.science/r/covid/data/OregonCOVID",Sys.Date(),".RData")))
```

These data are current as of `r max(Oregon.COVID$Scraped.date)`.


## Building a base map

To build a map to work from, I need a map library.  Load the `tigris` library then grab the map as an `sf` object; there is a `geom_sf` that makes them easy to work with.  Finally, I join the map to the data.

```{r, message=FALSE, warning=FALSE, results='hide'}
library(tigris); library(rgdal); library(htmltools); library(viridis); library(sf); library(viridis)
counties.t <- counties(state = "41", resolution = "500k", class="sf")
Map.Me <- left_join(counties.t,Oregon.COVID, by=c("NAME" = "County"))
```

# The Whole Thing: An Animation

I will use a ggplot to build Oregon's map and fill it with case numbers.  `geom_sf()` plots the geometry.  I have to repel the labels to prevent print overlap, and scheme the colors.  The last step is to animate it by time. If I stop the label repelling, they will not bounce but it adds excitement.

```{r}
library(ggrepel); library(ggthemes); library(gganimate)
library(patchwork); library(hrbrthemes)
Anim1 <- Map.Me %>% 
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME, group=NAME)) + 
  geom_sf() +
  geom_label_repel(stat = "sf_coordinates",
    min.segment.length = 0,
    colour = "white",
    segment.colour = "white",
    size = 3,
    box.padding = unit(0.05, "lines"))  + scale_fill_continuous_tableau("Red") + theme_minimal() + labs(title="COVID-19 in Oregon", subtitle="{frame_time}", x="", y="", caption="Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19") + transition_time(date)
ResA <- animate(Anim1, end_pause=100, nframes=200)
ResA
```

# Some Data on Testing

What is the status of testing?

```{r}
OR.Testing <- Oregon.Tests %>% group_by(date) %>% summarise(Total = sum(Outcome))
Test1 <- Oregon.Tests %>% ggplot(.) + aes(x=date, y=Outcome, fill=Category, label=Outcome) + geom_col() + geom_label(col="magenta", show.legend = FALSE) + scale_fill_viridis_d() + labs(title="COVID-19 Testing in Oregon", y="Tests", x="Date", subtitle="Total shown as label", caption = "data: https://govstatus.egov.com/OR-OHA-COVID-19") + geom_label(data=OR.Testing, aes(x=date, y=Total+100, label=Total), fill="white", color="black", inherit.aes = FALSE)
Test1
```

# A Second Look at Testing

We should worry about the degree to which tests are applied at all randomly; they are surely not.  As a result, what it means to calculate or break down probability based on having been tested is subject to so many important caveats that vary over time.  It is important to note that this is also cumulative.

```{r}
Test2 <- Oregon.Tests %>% ggplot(.) + aes(x=date, y=Outcome, fill=Category, label=Outcome) + geom_col(position = "fill") + scale_fill_viridis_d() + labs(title="COVID-19 Testing in Oregon", y="Proportion of Tests", x="Date", caption = "data: https://govstatus.egov.com/OR-OHA-COVID-19")
Test2
```

## A Better Look at This

```{r}
MyDat <- Oregon.Tests %>% 
  pivot_wider(., names_from = Category, values_from = Outcome) %>% 
  mutate(Positive.Chg = Positive - lag(Positive, order_by = date), 
         Negative.Chg = Negative - lag(Negative, order_by = date)) %>% 
  mutate(Total = Positive.Chg + Negative.Chg) %>% 
  mutate(Positive.Pct = round(Positive.Chg / Total, digits=3)) %>% 
  select(date, Positive.Chg, Negative.Chg, Positive.Pct) %>% 
  pivot_longer(., c(Negative.Chg, Positive.Chg), names_to = "Outcome", values_to = "Test.Changes")
MyDat %>% ggplot(., aes(x=date, y=Test.Changes, fill=Outcome)) + geom_col(position="fill") + geom_label(data=MyDat, aes(x=date, y=Positive.Pct, label=Positive.Pct), inherit.aes = TRUE, show.legend=FALSE) + scale_fill_ipsum() + labs(title="Daily Distribution of Test Outcomes", subtitle="Percent of Positive Tests Shown")
```


# Hospitalization Data

How do positive cases and hospitalization relate?

```{r}
Hos1 <- OR.Hosp %>% filter(Hospitalized.!="Total") %>% ggplot(., aes(x=date, y=Number.of.cases,fill=Hospitalized.)) + geom_col() + scale_fill_ipsum() + labs(x="Date", y="Number of COVID Positives", fill="Hospitalized?", title="Hospitalization Status of COVID-19 Positives in Oregon")
Hos2 <- OR.Hosp %>% filter(Hospitalized.!="Total") %>% ggplot(., aes(x=date, y=Number.of.cases,fill=Hospitalized.)) + geom_col(position="fill") + scale_fill_ipsum() + labs(x="Date", y="Number of COVID Positives", fill="Hospitalized?", title="Hospitalization Status of COVID-19 Positives in Oregon")
Hos1 + Hos2
```

# Age Data

How does this break down by age?  *I had to break this into two parts.  They changed the classification method on March 25, 2020.*

```{r}
OR.Ages1 <- OR.Ages %>% filter(date < "2020-03-25")
Age1 <- OR.Ages1 %>% ggplot(., aes(x=date, y=Number.of.cases, fill=Age.group)) + geom_col() + scale_fill_ipsum() + labs(x="Date", y="Number of COVID-19 Positives") + theme_economist() + guides(fill=FALSE)
Age2 <- OR.Ages1 %>% ggplot(.) +
 aes(x = date, fill = Age.group, weight = Number.of.cases) +
 geom_bar(position = "fill") +
 scale_fill_ipsum() + labs(x="Date", y="Proportion of COVID-19 Positives") +
 theme_minimal()
Age1 + Age2
```

### The Revision

```{r}
OR.Ages1 <- OR.Ages %>% filter(date > "2020-03-24")
Age1 <- OR.Ages1 %>% ggplot(., aes(x=date, y=Number.of.cases, fill=Age.group)) + geom_col() + scale_fill_viridis(discrete = TRUE) + labs(x="Date", y="Number of COVID-19 Positives") + theme_economist() + guides(fill=FALSE)
Age2 <- OR.Ages1 %>% ggplot(.) +
 aes(x = date, fill = Age.group, weight = Number.of.cases) +
 geom_bar(position = "fill") +
 scale_fill_viridis(discrete=TRUE) + labs(x="Date", y="Percent of COVID-19 Positives") +
 theme_minimal()
Age1 + Age2
```

## Some Gender Data

## Hospital Capacity Data


## A Mapping Function

To save time later, I turned the plots into a function so that I can use to reproduce each frame.  Two inputs to the function, the dataset that is always the merged data from above and the date that I want to plot located in `date1` in a `YYYY-MM-DD` format.

```{r}
Plot.COVID <- function(date1, data) {
data %>% filter(date==date1) %>%
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME)) + 
  geom_sf() +
  geom_label_repel(stat = "sf_coordinates",
    min.segment.length = 0,
    colour = "white",
    segment.colour = "white",
    size = 3,
    box.padding = unit(0.05, "lines"))  + scale_fill_continuous_tableau("Red") + theme_minimal() + labs(title="COVID-19 in Oregon", subtitle=date1, x="", y="", caption="Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19")
}
```

## The Result for 03/18/2020

This is the first date for which I can find data.  The `waybackmachine` was crucial.

```{r}
Plot.COVID("2020-03-18", Map.Me)
```


## The Result for 03/19/2020

```{r}
Plot.COVID("2020-03-19", Map.Me)
```


## The Result for 03/20/2020

```{r}
Plot.COVID("2020-03-20", Map.Me)
```


## The Result for 03/21/2020

```{r}
Plot.COVID("2020-03-21", Map.Me)
```

## The Result for 03/22/2020

```{r}
Plot.COVID("2020-03-22", Map.Me)
```


## The Result for 03/23/2020

```{r}
Plot.COVID("2020-03-23", Map.Me)
```

## The Result for 03/24/2020

```{r}
Plot.COVID("2020-03-24", Map.Me)
```

## The Result for 03/25/2020

```{r}
Plot.COVID("2020-03-25", Map.Me)
```

## The Result for 03/26/2020

```{r}
library(plotly); library(widgetframe); library(ggthemes); library(RColorBrewer)
Map.Me <- Map.Me %>% mutate(TTip = paste0("Deaths: ",Deaths,"<br> Negative Tests:",Negative.test.results))
Res.1 <- Map.Me %>% filter(date==Sys.Date()) %>%
  ggplot(., aes(geometry=geometry, fill=Number.of.cases, label=NAME, text=TTip)) + 
  geom_sf() + 
  scale_fill_viridis_c(option = "A") + 
  theme_map() + 
  labs(title="COVID-19 in Oregon", subtitle=Sys.Date(), x="", y="", caption="Made with R, ggplot2, and ggrepel by @PieRatio \n data: https://govstatus.egov.com/OR-OHA-COVID-19", fill="COVID-19 Cases")
ggp <- ggplotly(Res.1)
frameWidget(ggp)
```
