---
title: "NYT COVID Forecast Aggregation"
date: "2021-04-21"
output:
  rmdformats::downcute:
    self_contained: true
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="new-york-times-data-on-covid" class="section level2">
<h2>New York Times Data on COVID</h2>
<p>I will grab the dataset from the NYT COVID data github. I will create two variables, New Cases and New Deaths to model. The final line uses aggregation to create the national data.</p>
<p>NB: This file takes a really long time to run; forecasting deaths took just under six hours.</p>
<pre class="r"><code>NYT.COVIDN &lt;- read.csv(url(&quot;https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv&quot;))
# Define a tsibble; the date is imported as character so mutate that first.
NYT.COVID &lt;- NYT.COVIDN %&gt;%
    mutate(date = as.Date(date)) %&gt;%
    as_tsibble(index = date, key = state) %&gt;%
    group_by(state) %&gt;%
    mutate(New.Cases = difference(cases), New.Deaths = difference(deaths)) %&gt;%
    filter(!(state %in% c(&quot;Guam&quot;, &quot;Puerto Rico&quot;, &quot;Virgin Islands&quot;, &quot;Northern Mariana Islands&quot;)))
NYT.COVID &lt;- NYT.COVID %&gt;%
    mutate(New.CasesP = as.numeric(New.Cases &gt;= 0) * New.Cases, New.DeathsP = as.numeric(New.Deaths &gt;= 
        0) * New.Deaths)
NYTAgg.COVID &lt;- NYT.COVID %&gt;%
    aggregate_key(state, New.CasesP = sum(New.CasesP, na.rm = TRUE), New.DeathsP = sum(New.DeathsP, 
        na.rm = TRUE), New.Cases = sum(New.Cases, na.rm = TRUE), New.Deaths = sum(New.Deaths, 
        na.rm = TRUE), cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE)) %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-31&quot;)) %&gt;%
    mutate(Day.of.Week = as.factor(wday(date, label = TRUE)))</code></pre>
<p>A basic visual for verification. First the subseries.</p>
<pre class="r"><code>library(patchwork)
plot1 &lt;- NYTAgg.COVID %&gt;%
    filter(!is_aggregated(state)) %&gt;%
    autoplot(New.CasesP) + guides(color = FALSE)
plot2 &lt;- NYTAgg.COVID %&gt;%
    filter(!is_aggregated(state)) %&gt;%
    autoplot(New.DeathsP) + guides(color = FALSE)
plot1/plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/BasePlot-1.png" width="672" /></p>
<p>Now the aggregates.</p>
<pre class="r"><code>plot1 &lt;- NYTAgg.COVID %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(New.CasesP)
plot2 &lt;- NYTAgg.COVID %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(New.DeathsP)
plot1/plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/BasePlotA-1.png" width="672" /></p>
<p>Are there day of week effects?</p>
<pre class="r"><code>NYTAgg.COVID %&gt;%
    model(TSLM(New.CasesP ~ Day.of.Week)) %&gt;%
    glance() %&gt;%
    filter(p_value &lt; 0.05)</code></pre>
<pre><code># A tibble: 14 x 16
   state        .model   r_squared adj_r_squared sigma2 statistic  p_value    df
   &lt;chr*&gt;       &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
 1 Arkansas   … TSLM(Ne…    0.0471        0.0320 6.67e5      3.12 5.42e- 3     7
 2 Connecticut… TSLM(Ne…    0.263         0.251  1.27e6     22.5  1.16e-22     7
 3 District of… TSLM(Ne…    0.0406        0.0254 6.64e3      2.67 1.51e- 2     7
 4 Hawaii     … TSLM(Ne…    0.0696        0.0548 4.76e3      4.71 1.22e- 4     7
 5 Idaho      … TSLM(Ne…    0.0792        0.0646 2.09e5      5.42 2.17e- 5     7
 6 Iowa       … TSLM(Ne…    0.0330        0.0176 9.05e5      2.15 4.74e- 2     7
 7 Kansas     … TSLM(Ne…    0.302         0.291  1.47e6     27.2  5.76e-27     7
 8 Louisiana  … TSLM(Ne…    0.141         0.127  1.38e6     10.3  1.30e-10     7
 9 Michigan   … TSLM(Ne…    0.101         0.0871 6.94e6      7.11 3.44e- 7     7
10 Mississippi… TSLM(Ne…    0.0586        0.0437 4.27e5      3.93 8.08e- 4     7
11 Rhode Islan… TSLM(Ne…    0.216         0.204  2.81e5     17.4  9.29e-18     7
12 South Dakot… TSLM(Ne…    0.0330        0.0177 1.35e5      2.15 4.69e- 2     7
13 Texas      … TSLM(Ne…    0.0341        0.0188 4.58e7      2.22 4.02e- 2     7
14 Washington … TSLM(Ne…    0.0675        0.0527 8.77e5      4.56 1.74e- 4     7
# … with 8 more variables: log_lik &lt;dbl&gt;, AIC &lt;dbl&gt;, AICc &lt;dbl&gt;, BIC &lt;dbl&gt;,
#   CV &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;, rank &lt;int&gt;</code></pre>
<p>In 12 states, there appear to be and in a few of them, those effects are large. Modelling this covariate seems useful. At the same time, this does nothing about the broad trends.</p>
</div>
<div id="training-and-testing" class="section level2">
<h2>Training and Testing</h2>
<p>That gives me the data that I want; now let me slice it up into training and test sets.</p>
<pre class="r"><code>COVID.Agg.Test &lt;- NYTAgg.COVID %&gt;%
    as_tibble() %&gt;%
    group_by(state) %&gt;%
    slice_tail(n = 14) %&gt;%
    ungroup() %&gt;%
    as_tsibble(index = date, key = state)
COVID.Agg.Train &lt;- anti_join(NYTAgg.COVID, COVID.Agg.Test) %&gt;%
    as_tsibble(index = date, key = state)</code></pre>
</div>
<div id="model-fitting" class="section level2">
<h2>Model Fitting</h2>
<p>Fit some models to the data.</p>
<pre class="r"><code>COVID.Models &lt;- COVID.Agg.Train %&gt;%
    model(WDARIMA = ARIMA(New.CasesP ~ Day.of.Week))</code></pre>
<p>Forecast the models.</p>
<pre class="r"><code>COVIDFC &lt;- COVID.Models %&gt;%
    forecast(new_data = COVID.Agg.Test)
COVIDFC %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 52 x 11
   .model  state           .type      ME   RMSE    MAE     MPE  MAPE  MASE RMSSE
   &lt;chr&gt;   &lt;chr*&gt;          &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 WDARIMA Alabama       … Test  302.     547.   329.    46.2   55.3   NaN   NaN
 2 WDARIMA Alaska        … Test  -13.4     82.3   66.0 -Inf    Inf     NaN   NaN
 3 WDARIMA Arizona       … Test   54.6    355.   317.     3.33  49.3   NaN   NaN
 4 WDARIMA Arkansas      … Test   72.6    104.    85.7   78.0   84.8   NaN   NaN
 5 WDARIMA California    … Test    9.47   726.   465.    -3.28  15.8   NaN   NaN
 6 WDARIMA Colorado      … Test  261.     553.   492.     6.21  30.6   NaN   NaN
 7 WDARIMA Connecticut   … Test  -65.3    336.   246.   NaN    Inf     NaN   NaN
 8 WDARIMA Delaware      … Test   41.6     70.2   63.5    7.32  19.6   NaN   NaN
 9 WDARIMA District of Co… Test    0.615   32.6   21.3   -6.40  18.8   NaN   NaN
10 WDARIMA Florida       … Test  919.    1550.  1238.     5.11  24.9   NaN   NaN
# … with 42 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Look at the aggregates.</p>
<pre class="r"><code>COVIDFC %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(NYTAgg.COVID %&gt;%
        filter(date &gt; as.Date(&quot;2021-03-01&quot;)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/AggFD-1.png" width="672" /></p>
<p>Look at Oregon.</p>
<pre class="r"><code>COVIDFC %&gt;%
    filter(state == &quot;Oregon&quot;) %&gt;%
    autoplot(NYTAgg.COVID %&gt;%
        filter(date &gt; as.Date(&quot;2021-03-01&quot;)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/OreFD-1.png" width="672" /></p>
</div>
<div id="prophet" class="section level2">
<h2>Prophet</h2>
<pre class="r"><code>library(prophet)
ProphMod &lt;- prophet::prophet(NYT.COVID %&gt;%
    filter(state == &quot;Oregon&quot;) %&gt;%
    select(ds = date, y = cases))
future &lt;- make_future_dataframe(ProphMod, periods = 30)
forecast &lt;- predict(ProphMod, future)
plot(ProphMod, forecast) + labs(x = &quot;Date&quot;, y = &quot;COVID-19 Cases&quot;, title = &quot;COVID-19 Forecast for Oregon: Using Prophet&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/ProphetFC-1.png" width="672" /></p>
<pre class="r"><code>prophet_plot_components(ProphMod, forecast)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/ProphetFC-2.png" width="672" /></p>
</div>
<div id="oregon" class="section level2">
<h2>Oregon</h2>
<pre class="r"><code>Oregon.C19 &lt;- NYTAgg.COVID %&gt;%
    filter(state == &quot;Oregon&quot;)
Oregon.C19 %&gt;%
    features(cases, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      6.15        0.01    3.98       0.1      2       0</code></pre>
<pre class="r"><code>Oregon.C19 %&gt;%
    features(deaths, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      6.05        0.01    3.39       0.1      2       0</code></pre>
<pre class="r"><code>Oregon.C19 %&lt;&gt;%
    mutate(New.Cases = difference(cases), New.Deaths = difference(deaths))</code></pre>
<pre class="r"><code># Visualize the differenced series
Oregon.C19 %&gt;%
    autoplot(New.Cases)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>Oregon.C19 %&gt;%
    autoplot(New.Deaths)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<pre class="r"><code># The Features of the Differenced Series
Oregon.C19 %&gt;%
    features(New.Cases, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      2.72        0.01   -3.46      0.01      1       0</code></pre>
<pre class="r"><code>Oregon.C19 %&gt;%
    features(New.Deaths, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      2.12        0.01   -10.9      0.01      1       0</code></pre>
</div>
<div id="decompositions" class="section level2">
<h2>Decompositions</h2>
<pre class="r"><code># Classical decomposition
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;additive&quot;)) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;multiplicative&quot;)) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-2.png" width="672" /></p>
<div id="cases" class="section level3">
<h3>Cases</h3>
<pre class="r"><code># Show the seasonally adjusted data
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;additive&quot;)) %&gt;%
    components() %&gt;%
    select(season_adjust) %&gt;%
    autoplot(season_adjust, alpha = 0.2) + geom_line(data = Oregon.C19, aes(x = date, 
    y = New.Cases), color = &quot;red&quot;, alpha = 0.2) + theme_ipsum_es() + labs(title = &quot;Seasonally Adjusted (Add) New Covid-19 Cases&quot;, 
    y = &quot;New Covid-19 Cases&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="deaths" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;multiplicative&quot;)) %&gt;%
    components() %&gt;%
    select(season_adjust) %&gt;%
    autoplot(season_adjust, alpha = 0.2) + geom_line(data = Oregon.C19, aes(x = date, 
    y = New.Cases), color = &quot;red&quot;, alpha = 0.2) + theme_ipsum_es() + labs(title = &quot;Seasonally Adjusted (Mult) New Covid-19 Cases&quot;, 
    y = &quot;New Covid-19 Cases&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<div id="stl" class="section level2">
<h2>STL</h2>
<p>The STL decomposition is a very useful tool.</p>
<div id="cases-1" class="section level3">
<h3>Cases</h3>
<pre class="r"><code># STL: Things are actually worse than the Fall....
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(STL(New.Cases ~ trend(window = 14) + season(period = &quot;1 week&quot;))) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/STL1-1.png" width="672" /></p>
<pre class="r"><code># The three peaks are interesting and we seem to be headed for a fourth that is
# already worse than the first.</code></pre>
</div>
<div id="deaths-1" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(STL(New.Deaths ~ trend(window = 14) + season(period = &quot;1 week&quot;))) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code># Deaths are far more rare and the peaks are less noticeable.</code></pre>
<p>What follows works off of the data with the zeroes removed.</p>
</div>
</div>
<div id="some-models" class="section level2">
<h2>Some Models</h2>
<pre class="r"><code>OC19 &lt;- Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;))
fitC &lt;- OC19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.CasesP ~ fourier(K = 1)), `K = 2` = ARIMA(New.CasesP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.CasesP ~ fourier(K = 3)), ARIMA = ARIMA(New.CasesP), 
        ETS = ETS(New.CasesP))
fitC %&gt;%
    glance()</code></pre>
<pre><code># A tibble: 5 x 12
  state  .model sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots      MSE
  &lt;chr*&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;      &lt;dbl&gt;
1 Oregon K = 1  22558.  -2461. 4934. 4934. 4958. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
2 Oregon K = 2  22511.  -2460. 4935. 4935. 4967. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
3 Oregon K = 3  22608.  -2459. 4939. 4939. 4978. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
4 Oregon ARIMA  24506.  -2478. 4964. 4964. 4980. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
5 Oregon ETS    22833.  -3065. 6150. 6150. 6189. &lt;NULL&gt;    &lt;NULL&gt;     22298.
# … with 2 more variables: AMSE &lt;dbl&gt;, MAE &lt;dbl&gt;</code></pre>
<pre class="r"><code># The best fit is K=2
fitC %&gt;%
    select(`K = 2`) %&gt;%
    forecast() %&gt;%
    autoplot() + autolayer(Oregon.C19 %&gt;%
    select(New.CasesP) %&gt;%
    filter(date &gt; as.Date(&quot;2021-02-01&quot;))) + theme_ipsum_rc() + labs(title = &quot;Harmonic Regression ARIMA Forecast of New COVID-19 Cases in Oregon&quot;) + 
    geom_point(aes(x = as.Date(&quot;2021-04-08&quot;), y = 678), size = 5) + geom_label(data = data.frame(x = as.Date(&quot;2021-03-31&quot;), 
    y = 736.446456504249, label = &quot;Oregon&#39;s Case Count for 4/8/2021&quot;), mapping = aes(x = x, 
    y = y, label = label), label.padding = unit(0.25, &quot;lines&quot;), label.r = unit(0.15, 
    &quot;lines&quot;), inherit.aes = FALSE)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div id="deaths-2" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>fitD &lt;- OC19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.DeathsP ~ fourier(K = 1)), `K = 2` = ARIMA(New.DeathsP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.DeathsP ~ fourier(K = 3)), ARIMA = ARIMA(New.DeathsP), 
        ETS = ETS(New.DeathsP))
fitD %&gt;%
    glance()</code></pre>
<pre><code># A tibble: 5 x 12
  state  .model sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots    MSE
  &lt;chr*&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;    &lt;dbl&gt;
1 Oregon K = 1    34.8  -1222. 2457. 2458. 2485. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
2 Oregon K = 2    34.4  -1218. 2454. 2455. 2490. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
3 Oregon K = 3    34.5  -1218. 2457. 2458. 2501. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
4 Oregon ARIMA    35.0  -1224. 2458. 2458. 2478. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
5 Oregon ETS      38.3  -1838. 3695. 3696. 3735. &lt;NULL&gt;    &lt;NULL&gt;     37.4
# … with 2 more variables: AMSE &lt;dbl&gt;, MAE &lt;dbl&gt;</code></pre>
</div>
</div>
<div id="a-bigger-set-of-models-and-reconciliation" class="section level2">
<h2>A Bigger Set of Models and Reconciliation</h2>
<pre class="r"><code>NC.Models &lt;- COVID.Agg.Train %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.CasesP ~ fourier(K = 1)), `K = 2` = ARIMA(New.CasesP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.CasesP ~ fourier(K = 3)), ARIMA = ARIMA(New.CasesP), 
        ETS = ETS(New.CasesP), NNET = NNETAR(New.CasesP ~ fourier(K = 2, period = &quot;1 week&quot;))) %&gt;%
    mutate(Combo1 = (`K = 2` + ARIMA + ETS)/3, Combo2 = (`K = 2` + ARIMA + ETS + 
        NNET)/4) %&gt;%
    reconcile(buARIMA = bottom_up(ARIMA), buK2 = bottom_up(`K = 2`), buETS = bottom_up(ETS), 
        buNN = bottom_up(NNET))</code></pre>
</div>
<div id="accuracy" class="section level2">
<h2>Accuracy</h2>
<pre class="r"><code>FC.Cases &lt;- NC.Models %&gt;%
    forecast(h = 14)</code></pre>
<pre class="r"><code>FC.Cases %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 624 x 11
   .model state           .type      ME   RMSE    MAE      MPE  MAPE  MASE RMSSE
   &lt;chr&gt;  &lt;chr*&gt;          &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 ARIMA  Alabama       … Test   187.    457.   287.    12.5    60.3   NaN   NaN
 2 ARIMA  Alaska        … Test   -44.5   107.    82.0 -Inf     Inf     NaN   NaN
 3 ARIMA  Arizona       … Test   -23.9   227.   165.   -13.4    26.0   NaN   NaN
 4 ARIMA  Arkansas      … Test    28.9    65.4   56.4    0.434  35.5   NaN   NaN
 5 ARIMA  California    … Test  -318.    589.   540.   -14.1    20.0   NaN   NaN
 6 ARIMA  Colorado      … Test   108.    557.   484.    -4.91   32.6   NaN   NaN
 7 ARIMA  Connecticut   … Test  -155.    396.   323.  -Inf     Inf     NaN   NaN
 8 ARIMA  Delaware      … Test    12.7    48.0   42.5    0.506  13.6   NaN   NaN
 9 ARIMA  District of Co… Test    -9.02   39.2   32.9  -17.6    30.6   NaN   NaN
10 ARIMA  Florida       … Test   408.   1630.  1170.   -12.5    32.5   NaN   NaN
# … with 614 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Assess the models over the units.</p>
<pre class="r"><code>FC.Cases %&gt;%
    accuracy(COVID.Agg.Test) %&gt;%
    group_by(state) %&gt;%
    slice_min(MAE) %&gt;%
    janitor::tabyl(.model) %&gt;%
    ggplot(aes(x = .model, y = n)) + geom_col() + theme_ipsum_rc()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="deaths-3" class="section level1">
<h1>Deaths</h1>
<pre class="r"><code>ND.Models &lt;- COVID.Agg.Train %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.DeathsP ~ fourier(K = 1)), `K = 2` = ARIMA(New.DeathsP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.DeathsP ~ fourier(K = 3)), ARIMA = ARIMA(New.DeathsP), 
        ETS = ETS(New.DeathsP), NNET = NNETAR(New.DeathsP ~ fourier(K = 2, period = &quot;1 week&quot;))) %&gt;%
    mutate(Combo1 = (`K = 2` + ARIMA + ETS)/3, Combo2 = (`K = 2` + ARIMA + ETS + 
        NNET)/4) %&gt;%
    reconcile(buARIMA = bottom_up(ARIMA), buK2 = bottom_up(`K = 2`), buETS = bottom_up(ETS), 
        buNN = bottom_up(NNET))</code></pre>
<div id="accuracy-1" class="section level2">
<h2>Accuracy</h2>
<pre class="r"><code>FC.Deaths &lt;- ND.Models %&gt;%
    forecast(h = 14)</code></pre>
<pre class="r"><code>FC.Deaths %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 624 x 11
   .model state            .type      ME   RMSE    MAE     MPE  MAPE  MASE RMSSE
   &lt;chr&gt;  &lt;chr*&gt;           &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 ARIMA  Alabama        … Test    0.750 13.8   12.3    NaN    Inf     NaN   NaN
 2 ARIMA  Alaska         … Test    1.33   5.54   2.24  -Inf    Inf     NaN   NaN
 3 ARIMA  Arizona        … Test   10.1   16.7   14.1    Inf    Inf     NaN   NaN
 4 ARIMA  Arkansas       … Test   -4.83   5.69   4.83  -Inf    Inf     NaN   NaN
 5 ARIMA  California     … Test   -3.25  36.2   27.9     -8.28  28.9   NaN   NaN
 6 ARIMA  Colorado       … Test   10.0   29.8   11.5   -Inf    Inf     NaN   NaN
 7 ARIMA  Connecticut    … Test    2.12   5.59   4.03  -Inf    Inf     NaN   NaN
 8 ARIMA  Delaware       … Test   -1.13   2.23   1.72  -Inf    Inf     NaN   NaN
 9 ARIMA  District of Col… Test   -0.269  0.887  0.697 -Inf    Inf     NaN   NaN
10 ARIMA  Florida        … Test  -11.1   18.9   15.6    -69.3   74.6   NaN   NaN
# … with 614 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Assess the models over the units.</p>
<pre class="r"><code>FC.Deaths %&gt;%
    accuracy(COVID.Agg.Test) %&gt;%
    group_by(state) %&gt;%
    slice_min(MAE) %&gt;%
    janitor::tabyl(.model) %&gt;%
    ggplot(aes(x = .model, y = n)) + geom_col() + theme_ipsum_rc()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
</div>
