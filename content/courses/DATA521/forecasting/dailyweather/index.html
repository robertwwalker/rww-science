---
title: "Forecasting the Weather: Daily"
date: "2021-04-23"
output:
  rmdformats::downcute:
    self_contained: true
    toc: true
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="loading-nws-data" class="section level2">
<h2>Loading NWS Data</h2>
<p>Load the data.</p>
<pre class="r"><code># There is one blank variable name and some garbage at the top.  Skip the first
# six rows and label M and - as missing.
NWS &lt;- read.csv(url(&quot;https://www.weather.gov/source/pqr/climate/webdata/Portland_dailyclimatedata.csv&quot;), 
    skip = 6, na.strings = c(&quot;M&quot;, &quot;-&quot;)) %&gt;%
    rename(Variable = X)</code></pre>
<p>One thing that will prove troublesome is that <code>/A</code> appears in a few places. I want to remove it. I will ask R to find all of the character columns and remove <code>/A</code>.</p>
<pre class="r"><code>NWS &lt;- NWS %&gt;%
    mutate(across(where(is.character), ~str_remove(.x, &quot;/A&quot;)))</code></pre>
<p>Let me produce the daily data.</p>
<pre class="r"><code>NWS.Daily &lt;- NWS %&gt;%
    select(-AVG.or.Total)
names(NWS.Daily) &lt;- c(&quot;YR&quot;, &quot;MO&quot;, &quot;Variable&quot;, paste0(&quot;Day.&quot;, 1:31))
NWS.Daily &lt;- NWS.Daily %&gt;%
    pivot_longer(., cols = starts_with(&quot;Day.&quot;), names_to = &quot;Day&quot;, values_to = &quot;value&quot;) %&gt;%
    mutate(Day = str_remove(Day, &quot;Day.&quot;)) %&gt;%
    pivot_wider(., names_from = &quot;Variable&quot;, values_from = &quot;value&quot;) %&gt;%
    mutate(PR = recode(PR, T = &quot;O.005&quot;), SN = recode(SN, T = &quot;O.005&quot;)) %&gt;%
    mutate(TX = as.numeric(TX), TN = as.numeric(TN), PR = as.numeric(PR), SN = as.numeric(SN), 
        date = as.Date(paste(MO, Day, YR, sep = &quot;-&quot;), format = &quot;%m-%d-%Y&quot;))
NWS.Daily.Clean &lt;- NWS.Daily %&gt;%
    filter(!(is.na(date))) %&gt;%
    filter(!is.na(TX)) %&gt;%
    as_tsibble(index = date)</code></pre>
</div>
<div id="daily-decompositions" class="section level2">
<h2>Daily Decompositions</h2>
<pre class="r"><code>Decompose.Me &lt;- function(data, var, trendW = 5, seasonW = 5) {
    var &lt;- ensym(var)
    model &lt;- data %&gt;%
        model(STL(!!var ~ trend(window = trendW) + season(window = seasonW, period = 7)))
    cmp &lt;- model %&gt;%
        components()
    plot &lt;- cmp %&gt;%
        autoplot()
    return(list(model = model, cmp = cmp, plot = plot))
}
MaxAvg.Result &lt;- NWS.Daily.Clean %&gt;%
    filter(YR &gt; 1999) %&gt;%
    Decompose.Me(., TX, trendW = 5)
MaxAvg.Result %&gt;%
    .$plot</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>To work with the STL seasonally adjusted data, we can isolate <code>season_adjust</code>. This is the core component in STL+…</p>
<p>Let me decompose one such series. Suppose that I wanted to seasonally adjust this. I already have it there. <code>season_7</code> is what I add to turn the <code>season_adjust</code> to the original.</p>
<pre class="r"><code>MaxAvg.Result %&gt;%
    .$cmp %&gt;%
    head(10) %&gt;%
    select(-.model)</code></pre>
<pre><code># A tsibble: 10 x 6 [1D]
   date          TX trend season_7 remainder season_adjust
   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
 1 2000-01-01    46  45.0    1.06   -0.0806           44.9
 2 2000-01-02    45  45.4    1.87   -2.23             43.1
 3 2000-01-03    45  46.7   -1.07   -0.586            46.1
 4 2000-01-04    50  48.7   -1.06    2.34             51.1
 5 2000-01-05    47  47.6   -0.884   0.239            47.9
 6 2000-01-06    40  45.9   -3.87   -2.05             43.9
 7 2000-01-07    51  47.0    3.99   -0.00399          47.0
 8 2000-01-08    51  48.1    0.844   2.10             50.2
 9 2000-01-09    48  46.0    2.04   -0.0523           46.0
10 2000-01-10    41  42.9   -0.951  -0.976            42.0</code></pre>
<p>So let me run with that. Borrowing from an earlier post…</p>
<pre class="r"><code>Usual.Suspects &lt;- function(data, Outcome) {
    Outcome &lt;- ensym(Outcome)
    fits &lt;- data %&gt;%
        model(`K = 1` = ARIMA(!!Outcome ~ fourier(K = 1) + PDQ(0, 0, 0)), `K = 2` = ARIMA(!!Outcome ~ 
            fourier(K = 2) + PDQ(0, 0, 0)), `K = 3` = ARIMA(!!Outcome ~ fourier(K = 3) + 
            PDQ(0, 0, 0)), ARIMA = ARIMA(!!Outcome), ETS = ETS(!!Outcome), NNET = NNETAR(!!Outcome ~ 
            fourier(K = 2)), prophet = prophet(!!Outcome ~ growth() + season(&quot;year&quot;, 
            12))) %&gt;%
        mutate(Combo1 = (`K = 2` + ARIMA + ETS)/3, Combo2 = (`K = 2` + ARIMA + ETS + 
            NNET)/4)
    return(fits)
}</code></pre>
</div>
<div id="automagics" class="section level2">
<h2>Automagics</h2>
<p>I want to write a magic function. It takes four inputs: data, Outcome, DateVar, and H.Horizon [defaults to 14]. The first one is the data. The next two inputs are <code>Outcome</code>, the outcome without quotation marks, and <code>DateVar</code> – the Date variable [the index of the tsibble], also unquoted. The final argument sets the forecast horizon [the plots will have two times this before them in real data from the <code>test</code> set]. I have tried to be copious in commenting this.</p>
<div id="a-monthly-forecast-function" class="section level3">
<h3>A Monthly Forecast Function</h3>
<pre class="r"><code>Accuse.Usual.Suspect &lt;- function(data, Outcome, DateVar, H.Horizon = 14) {
    # Turn the symbols -- names that will make sense in their environments when
    # called -- that the user supplies into symbolics.  This is the role of ensym.
    Outcome &lt;- ensym(Outcome)
    DateVar &lt;- ensym(DateVar)
    # Create test using H.Horizon
    test &lt;- data %&gt;%
        slice_max(., order_by = !!DateVar, n = H.Horizon)  # Create train
    train &lt;- data %&gt;%
        anti_join(., test)
    # Estimate some models and store them as fits.  !! calls the variable name in the
    # given environment
    fits &lt;- train %&gt;%
        Usual.Suspects(., !!Outcome)
    # Forecast the models
    FC &lt;- fits %&gt;%
        forecast(h = H.Horizon)
    # Compare train and test using accuracy
    Accuracy.Table &lt;- FC %&gt;%
        accuracy(test)
    # Show the best fit
    Min.Model &lt;- Accuracy.Table %&gt;%
        slice_min(., order_by = MAE, n = 1)
    # Report on the best fitting model
    Min.Report &lt;- fits %&gt;%
        select(Min.Model$.model) %&gt;%
        report()
    # Create a plot of the time series residuals for the best fit
    Min.Res.Plot &lt;- fits %&gt;%
        select(Min.Model$.model) %&gt;%
        gg_tsresiduals()
    # Create a forecast plot for the best fitting model.
    Min.ForeCPlot &lt;- FC %&gt;%
        filter(.model == Min.Model$.model) %&gt;%
        autoplot() + autolayer(test %&gt;%
        select(!!Outcome)) + autolayer(data %&gt;%
        slice_max(., order_by = !!DateVar, n = H.Horizon * 3) %&gt;%
        select(!!Outcome)) + theme_ipsum_rc() + labs(title = &quot;Winner Forecast&quot;)
    # Return a named list with all the stuff we calculated along the way.
    fit.list &lt;- list(test = test, train = train, Model.Fits = fits, Model.Forecasts = FC, 
        Accuracy.Table = Accuracy.Table, Min.Model = Min.Model, Min.Report = Min.Report, 
        Min.Res.Plot = Min.Res.Plot, Min.Forecast.Plot = Min.ForeCPlot)
    return(fit.list)
}</code></pre>
</div>
</div>
<div id="maximum-average-temperature" class="section level2">
<h2>Maximum Average Temperature</h2>
<p>Try out the big function. Using all the data will be slow. Let’s try everything this century.</p>
<pre class="r"><code>SAData &lt;- MaxAvg.Result %&gt;%
    .$cmp %&gt;%
    select(-.model) %&gt;%
    as_tsibble(index = date)
MaxAvg.Res &lt;- SAData %&gt;%
    Accuse.Usual.Suspect(., Outcome = season_adjust, DateVar = date, H.Horizon = 14)</code></pre>
<pre><code>Series: season_adjust 
Model: NNAR(38,1,22)[7] 

Average of 20 networks, each of which is
a 42-22-1 network with 969 weights
options were - linear output units 

sigma^2 estimated as 5.798</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/MaxWins-1.png" width="672" />
What Won?</p>
<pre class="r"><code>MaxAvg.Res$Min.Model</code></pre>
<pre><code># A tibble: 1 x 10
  .model .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1
  &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 NNET   Test   1.68  3.47  2.95  2.99  5.98   NaN   NaN 0.327</code></pre>
<p>All the models on a 14 day horizon?</p>
<pre class="r"><code>MaxAvg.Res$Accuracy.Table</code></pre>
<pre><code># A tibble: 9 x 10
  .model  .type      ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1
  &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 ARIMA   Test  -0.987   4.54  3.84 -2.84   8.14   NaN   NaN 0.531
2 Combo1  Test  -1.04    4.53  3.76 -2.94   7.99   NaN   NaN 0.547
3 Combo2  Test  -0.376   4.04  3.23 -1.49   6.79   NaN   NaN 0.506
4 ETS     Test  -0.0611  4.26  3.32 -0.878  6.93   NaN   NaN 0.493
5 K = 1   Test  -2.07    5.08  4.33 -5.11   9.30   NaN   NaN 0.609
6 K = 2   Test  -2.07    5.08  4.33 -5.11   9.29   NaN   NaN 0.609
7 K = 3   Test  -2.07    5.08  4.33 -5.11   9.29   NaN   NaN 0.609
8 NNET    Test   1.68    3.47  2.95  2.99   5.98   NaN   NaN 0.327
9 prophet Test   2.84    5.00  4.04  5.22   8.05   NaN   NaN 0.417</code></pre>
<p>Residuals?</p>
<pre class="r"><code>MaxAvg.Res$Min.Res.Plot</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Try out a result.</p>
<pre class="r"><code>MaxAvg.Res$Min.Forecast.Plot</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
