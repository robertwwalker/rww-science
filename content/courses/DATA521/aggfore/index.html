---
title: "NYT COVID Forecast Aggregation with Covariates"
date: "2021-04-17"
output:
  rmdformats::downcute:
    self_contained: true
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="new-york-times-data-on-covid" class="section level2">
<h2>New York Times Data on COVID</h2>
<p>I will grab the dataset from the NYT COVID data github. I will create two variables, New Cases and New Deaths to model. The final line use aggregation to create the national data.</p>
<pre class="r"><code>NYT.COVIDN &lt;- read.csv(url(&quot;https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv&quot;))
# Define a tsibble; the date is imported as character so mutate that first.
NYT.COVID &lt;- NYT.COVIDN %&gt;%
    mutate(date = as.Date(date)) %&gt;%
    as_tsibble(index = date, key = state) %&gt;%
    group_by(state) %&gt;%
    mutate(New.Cases = difference(cases), New.Deaths = difference(deaths)) %&gt;%
    filter(!(state %in% c(&quot;Guam&quot;, &quot;Puerto Rico&quot;, &quot;Virgin Islands&quot;, &quot;Northern Mariana Islands&quot;)))
NYT.COVID &lt;- NYT.COVID %&gt;%
    mutate(New.CasesP = as.numeric(New.Cases &gt;= 0) * New.Cases, New.DeathsP = as.numeric(New.Deaths &gt;= 
        0) * New.Deaths)
NYTAgg.COVID &lt;- NYT.COVID %&gt;%
    aggregate_key(state, New.CasesP = sum(New.CasesP, na.rm = TRUE), New.DeathsP = sum(New.DeathsP, 
        na.rm = TRUE), New.Cases = sum(New.Cases, na.rm = TRUE), New.Deaths = sum(New.Deaths, 
        na.rm = TRUE), cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE)) %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-31&quot;)) %&gt;%
    mutate(Day.of.Week = as.factor(wday(date, label = TRUE)))</code></pre>
<p>A basic visual for verification. First the subseries.</p>
<pre class="r"><code>library(patchwork)
plot1 &lt;- NYTAgg.COVID %&gt;%
    filter(!is_aggregated(state)) %&gt;%
    autoplot(New.CasesP) + guides(color = FALSE)
plot2 &lt;- NYTAgg.COVID %&gt;%
    filter(!is_aggregated(state)) %&gt;%
    autoplot(New.DeathsP) + guides(color = FALSE)
plot1/plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/BasePlot-1.png" width="672" /></p>
<p>Now the aggregates.</p>
<pre class="r"><code>plot1 &lt;- NYTAgg.COVID %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(New.CasesP)
plot2 &lt;- NYTAgg.COVID %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(New.DeathsP)
plot1/plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/BasePlotA-1.png" width="672" /></p>
<p>Are there day of week effects?</p>
<pre class="r"><code>NYTAgg.COVID %&gt;%
    model(TSLM(New.CasesP ~ Day.of.Week)) %&gt;%
    glance() %&gt;%
    filter(p_value &lt; 0.05)</code></pre>
<pre><code># A tibble: 12 x 16
   state        .model   r_squared adj_r_squared sigma2 statistic  p_value    df
   &lt;chr*&gt;       &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
 1 Arkansas   … TSLM(Ne…    0.0450        0.0297 6.70e5      2.94 8.23e- 3     7
 2 Connecticut… TSLM(Ne…    0.259         0.247  1.29e6     21.8  5.72e-22     7
 3 District of… TSLM(Ne…    0.0401        0.0247 6.71e3      2.60 1.74e- 2     7
 4 Hawaii     … TSLM(Ne…    0.0688        0.0538 4.80e3      4.60 1.59e- 4     7
 5 Idaho      … TSLM(Ne…    0.0773        0.0625 2.10e5      5.22 3.55e- 5     7
 6 Kansas     … TSLM(Ne…    0.302         0.291  1.48e6     27.0  9.67e-27     7
 7 Louisiana  … TSLM(Ne…    0.143         0.129  1.38e6     10.4  1.12e-10     7
 8 Michigan   … TSLM(Ne…    0.0975        0.0830 6.84e6      6.73 8.74e- 7     7
 9 Mississippi… TSLM(Ne…    0.0562        0.0411 4.29e5      3.71 1.34e- 3     7
10 Rhode Islan… TSLM(Ne…    0.213         0.201  2.84e5     16.9  2.72e-17     7
11 Texas      … TSLM(Ne…    0.0332        0.0177 4.61e7      2.14 4.81e- 2     7
12 Washington … TSLM(Ne…    0.0665        0.0516 8.82e5      4.44 2.34e- 4     7
# … with 8 more variables: log_lik &lt;dbl&gt;, AIC &lt;dbl&gt;, AICc &lt;dbl&gt;, BIC &lt;dbl&gt;,
#   CV &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;, rank &lt;int&gt;</code></pre>
<p>In 12 states, there appear to be and in a few of them, those effects are large. Modelling this covariate seems useful. At the same time, this does nothing about the broad trends.</p>
</div>
<div id="training-and-testing" class="section level2">
<h2>Training and Testing</h2>
<p>That gives me the data that I want; now let me slice it up into training and test sets.</p>
<pre class="r"><code>COVID.Agg.Test &lt;- NYTAgg.COVID %&gt;%
    as_tibble() %&gt;%
    group_by(state) %&gt;%
    slice_tail(n = 14) %&gt;%
    ungroup() %&gt;%
    as_tsibble(index = date, key = state)
COVID.Agg.Train &lt;- anti_join(NYTAgg.COVID, COVID.Agg.Test) %&gt;%
    as_tsibble(index = date, key = state)</code></pre>
</div>
<div id="model-fitting" class="section level2">
<h2>Model Fitting</h2>
<p>Fit some models to the data.</p>
<pre class="r"><code>COVID.Models &lt;- COVID.Agg.Train %&gt;%
    model(WDARIMA = ARIMA(New.CasesP ~ Day.of.Week))</code></pre>
<p>Forecast the models.</p>
<pre class="r"><code>COVIDFC &lt;- COVID.Models %&gt;%
    forecast(new_data = COVID.Agg.Test)
COVIDFC %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 52 x 11
   .model  state           .type       ME   RMSE   MAE     MPE  MAPE  MASE RMSSE
   &lt;chr&gt;   &lt;chr*&gt;          &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 WDARIMA Alabama       … Test   118.     396.  228.    -6.63  69.9   NaN   NaN
 2 WDARIMA Alaska        … Test   -47.6    145.  115.  -Inf    Inf     NaN   NaN
 3 WDARIMA Arizona       … Test    70.6    341.  297.     8.83  48.4   NaN   NaN
 4 WDARIMA Arkansas      … Test   121.     141.  121.   114.   114.    NaN   NaN
 5 WDARIMA California    … Test  -209.     709.  578.   -11.2   21.1   NaN   NaN
 6 WDARIMA Colorado      … Test    94.2    486.  426.    -3.78  29.1   NaN   NaN
 7 WDARIMA Connecticut   … Test  -447.     544.  476.  -Inf    Inf     NaN   NaN
 8 WDARIMA Delaware      … Test    -0.742   62.3  50.1   -5.32  17.1   NaN   NaN
 9 WDARIMA District of Co… Test   -19.0     37.7  33.6  -23.9   31.8   NaN   NaN
10 WDARIMA Florida       … Test   268.    1340.  908.    -7.84  22.8   NaN   NaN
# … with 42 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Look at the aggregates.</p>
<pre class="r"><code>COVIDFC %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(NYTAgg.COVID %&gt;%
        filter(date &gt; as.Date(&quot;2021-03-01&quot;)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/AggFD-1.png" width="672" /></p>
<p>Look at Oregon.</p>
<pre class="r"><code>COVIDFC %&gt;%
    filter(state == &quot;Oregon&quot;) %&gt;%
    autoplot(NYTAgg.COVID %&gt;%
        filter(date &gt; as.Date(&quot;2021-03-01&quot;)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/OreFD-1.png" width="672" /></p>
<p>Assess the models over the units.</p>
<pre class="r"><code>COVIDFC %&gt;%
    accuracy(COVID.Agg.Test) %&gt;%
    group_by(state) %&gt;%
    slice_min(MAE) %&gt;%
    janitor::tabyl(.model) %&gt;%
    ggplot(aes(x = .model, y = n)) + geom_col() + theme_ipsum_rc()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="prophet" class="section level2">
<h2>Prophet</h2>
<pre class="r"><code>library(prophet)
ProphMod &lt;- prophet::prophet(NYT.COVID %&gt;%
    filter(state == &quot;Oregon&quot;) %&gt;%
    select(ds = date, y = cases))
future &lt;- make_future_dataframe(ProphMod, periods = 30)
forecast &lt;- predict(ProphMod, future)
plot(ProphMod, forecast) + labs(x = &quot;Date&quot;, y = &quot;COVID-19 Cases&quot;, title = &quot;COVID-19 Forecast for Oregon: Using Prophet&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/ProphetFC-1.png" width="672" /></p>
<pre class="r"><code>prophet_plot_components(ProphMod, forecast)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/ProphetFC-2.png" width="672" /></p>
</div>
<div id="oregon" class="section level2">
<h2>Oregon</h2>
<pre class="r"><code>Oregon.C19 &lt;- NYTAgg.COVID %&gt;%
    filter(state == &quot;Oregon&quot;)
Oregon.C19 %&gt;%
    features(cases, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      6.06        0.01    3.96       0.1      2       0</code></pre>
<pre class="r"><code>Oregon.C19 %&gt;%
    features(deaths, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      5.96        0.01    3.66       0.1      2       0</code></pre>
<pre class="r"><code>Oregon.C19 %&lt;&gt;%
    mutate(New.Cases = difference(cases), New.Deaths = difference(deaths))</code></pre>
<pre class="r"><code># Visualize the differenced series
Oregon.C19 %&gt;%
    autoplot(New.Cases)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>Oregon.C19 %&gt;%
    autoplot(New.Deaths)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-2.png" width="672" /></p>
<pre class="r"><code># The Features of the Differenced Series
Oregon.C19 %&gt;%
    features(New.Cases, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      2.72        0.01   -3.38    0.0145      1       0</code></pre>
<pre class="r"><code>Oregon.C19 %&gt;%
    features(New.Deaths, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      2.23        0.01   -10.8      0.01      1       0</code></pre>
</div>
<div id="decompositions" class="section level2">
<h2>Decompositions</h2>
<pre class="r"><code># Classical decomposition
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;additive&quot;)) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;multiplicative&quot;)) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-2.png" width="672" /></p>
<div id="cases" class="section level3">
<h3>Cases</h3>
<pre class="r"><code># Show the seasonally adjusted data
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;additive&quot;)) %&gt;%
    components() %&gt;%
    select(season_adjust) %&gt;%
    autoplot(season_adjust, alpha = 0.2) + geom_line(data = Oregon.C19, aes(x = date, 
    y = New.Cases), color = &quot;red&quot;, alpha = 0.2) + theme_ipsum_es() + labs(title = &quot;Seasonally Adjusted (Add) New Covid-19 Cases&quot;, 
    y = &quot;New Covid-19 Cases&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="deaths" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;multiplicative&quot;)) %&gt;%
    components() %&gt;%
    select(season_adjust) %&gt;%
    autoplot(season_adjust, alpha = 0.2) + geom_line(data = Oregon.C19, aes(x = date, 
    y = New.Cases), color = &quot;red&quot;, alpha = 0.2) + theme_ipsum_es() + labs(title = &quot;Seasonally Adjusted (Mult) New Covid-19 Cases&quot;, 
    y = &quot;New Covid-19 Cases&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
</div>
<div id="stl" class="section level2">
<h2>STL</h2>
<p>The STL decomposition is a very useful tool.</p>
<div id="cases-1" class="section level3">
<h3>Cases</h3>
<pre class="r"><code># STL: Things are actually worse than the Fall....
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(STL(New.Cases ~ trend(window = 14) + season(period = &quot;1 week&quot;))) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/STL1-1.png" width="672" /></p>
<pre class="r"><code># The three peaks are interesting and we seem to be headed for a fourth that is
# already worse than the first.</code></pre>
</div>
<div id="deaths-1" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(STL(New.Deaths ~ trend(window = 14) + season(period = &quot;1 week&quot;))) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code># Deaths are far more rare and the peaks are less noticeable.</code></pre>
</div>
</div>
<div id="some-models" class="section level2">
<h2>Some Models</h2>
<pre class="r"><code>OC19 &lt;- Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;))
fitC &lt;- OC19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.CasesP ~ fourier(K = 1)), `K = 2` = ARIMA(New.CasesP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.CasesP ~ fourier(K = 3)), ARIMA = ARIMA(New.CasesP), 
        ETS = ETS(New.CasesP))
fitC %&gt;%
    glance()</code></pre>
<pre><code># A tibble: 5 x 12
  state  .model sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots      MSE
  &lt;chr*&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;      &lt;dbl&gt;
1 Oregon K = 1  22733.  -2437. 4885. 4886. 4909. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
2 Oregon K = 2  22680.  -2435. 4886. 4887. 4918. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
3 Oregon K = 3  22774.  -2435. 4890. 4891. 4929. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
4 Oregon ARIMA  24648.  -2453. 4914. 4914. 4930. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
5 Oregon ETS    22818.  -3029. 6084. 6085. 6136. &lt;NULL&gt;    &lt;NULL&gt;     22097.
# … with 2 more variables: AMSE &lt;dbl&gt;, MAE &lt;dbl&gt;</code></pre>
<pre class="r"><code># The best fit is K=2
fitC %&gt;%
    select(`K = 2`) %&gt;%
    forecast() %&gt;%
    autoplot() + autolayer(Oregon.C19 %&gt;%
    select(New.CasesP) %&gt;%
    filter(date &gt; as.Date(&quot;2021-02-01&quot;))) + theme_ipsum_rc() + labs(title = &quot;Harmonic Regression ARIMA Forecast of New COVID-19 Cases in Oregon&quot;) + 
    geom_point(aes(x = as.Date(&quot;2021-04-08&quot;), y = 678), size = 5) + geom_label(data = data.frame(x = as.Date(&quot;2021-03-31&quot;), 
    y = 736.446456504249, label = &quot;Oregon&#39;s Case Count for 4/8/2021&quot;), mapping = aes(x = x, 
    y = y, label = label), label.padding = unit(0.25, &quot;lines&quot;), label.r = unit(0.15, 
    &quot;lines&quot;), inherit.aes = FALSE)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<div id="deaths-2" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>fitD &lt;- OC19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.DeathsP ~ fourier(K = 1)), `K = 2` = ARIMA(New.DeathsP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.DeathsP ~ fourier(K = 3)), ARIMA = ARIMA(New.DeathsP), 
        ETS = ETS(New.DeathsP))
fitD %&gt;%
    glance()</code></pre>
<pre><code># A tibble: 5 x 12
  state  .model sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots    MSE
  &lt;chr*&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;    &lt;dbl&gt;
1 Oregon K = 1    35.1  -1210. 2435. 2435. 2462. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
2 Oregon K = 2    34.7  -1207. 2432. 2432. 2467. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
3 Oregon K = 3    34.8  -1206. 2435. 2436. 2478. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
4 Oregon ARIMA    35.3  -1213. 2436. 2436. 2455. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
5 Oregon ETS      38.6  -1818. 3656. 3657. 3695. &lt;NULL&gt;    &lt;NULL&gt;     37.7
# … with 2 more variables: AMSE &lt;dbl&gt;, MAE &lt;dbl&gt;</code></pre>
</div>
</div>
