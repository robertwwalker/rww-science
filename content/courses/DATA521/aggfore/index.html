---
title: "NYT COVID Forecast Aggregation"
date: "2021-04-18"
output:
  rmdformats::downcute:
    self_contained: true
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="new-york-times-data-on-covid" class="section level2">
<h2>New York Times Data on COVID</h2>
<p>I will grab the dataset from the NYT COVID data github. I will create two variables, New Cases and New Deaths to model. The final line uses aggregation to create the national data.</p>
<p>NB: This file takes a really long time to run; forecasting deaths took just under six hours.</p>
<pre class="r"><code>NYT.COVIDN &lt;- read.csv(url(&quot;https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv&quot;))
# Define a tsibble; the date is imported as character so mutate that first.
NYT.COVID &lt;- NYT.COVIDN %&gt;%
    mutate(date = as.Date(date)) %&gt;%
    as_tsibble(index = date, key = state) %&gt;%
    group_by(state) %&gt;%
    mutate(New.Cases = difference(cases), New.Deaths = difference(deaths)) %&gt;%
    filter(!(state %in% c(&quot;Guam&quot;, &quot;Puerto Rico&quot;, &quot;Virgin Islands&quot;, &quot;Northern Mariana Islands&quot;)))
NYT.COVID &lt;- NYT.COVID %&gt;%
    mutate(New.CasesP = as.numeric(New.Cases &gt;= 0) * New.Cases, New.DeathsP = as.numeric(New.Deaths &gt;= 
        0) * New.Deaths)
NYTAgg.COVID &lt;- NYT.COVID %&gt;%
    aggregate_key(state, New.CasesP = sum(New.CasesP, na.rm = TRUE), New.DeathsP = sum(New.DeathsP, 
        na.rm = TRUE), New.Cases = sum(New.Cases, na.rm = TRUE), New.Deaths = sum(New.Deaths, 
        na.rm = TRUE), cases = sum(cases, na.rm = TRUE), deaths = sum(deaths, na.rm = TRUE)) %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-31&quot;)) %&gt;%
    mutate(Day.of.Week = as.factor(wday(date, label = TRUE)))</code></pre>
<p>A basic visual for verification. First the subseries.</p>
<pre class="r"><code>library(patchwork)
plot1 &lt;- NYTAgg.COVID %&gt;%
    filter(!is_aggregated(state)) %&gt;%
    autoplot(New.CasesP) + guides(color = FALSE)
plot2 &lt;- NYTAgg.COVID %&gt;%
    filter(!is_aggregated(state)) %&gt;%
    autoplot(New.DeathsP) + guides(color = FALSE)
plot1/plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/BasePlot-1.png" width="672" /></p>
<p>Now the aggregates.</p>
<pre class="r"><code>plot1 &lt;- NYTAgg.COVID %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(New.CasesP)
plot2 &lt;- NYTAgg.COVID %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(New.DeathsP)
plot1/plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/BasePlotA-1.png" width="672" /></p>
<p>Are there day of week effects?</p>
<pre class="r"><code>NYTAgg.COVID %&gt;%
    model(TSLM(New.CasesP ~ Day.of.Week)) %&gt;%
    glance() %&gt;%
    filter(p_value &lt; 0.05)</code></pre>
<pre><code># A tibble: 12 x 16
   state        .model   r_squared adj_r_squared sigma2 statistic  p_value    df
   &lt;chr*&gt;       &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
 1 Arkansas   … TSLM(Ne…    0.0449        0.0296 6.70e5      2.94 8.19e- 3     7
 2 Connecticut… TSLM(Ne…    0.260         0.248  1.28e6     21.9  4.09e-22     7
 3 District of… TSLM(Ne…    0.0401        0.0247 6.69e3      2.61 1.72e- 2     7
 4 Hawaii     … TSLM(Ne…    0.0689        0.0540 4.79e3      4.62 1.51e- 4     7
 5 Idaho      … TSLM(Ne…    0.0784        0.0636 2.10e5      5.31 2.81e- 5     7
 6 Kansas     … TSLM(Ne…    0.303         0.292  1.47e6     27.2  6.99e-27     7
 7 Louisiana  … TSLM(Ne…    0.145         0.131  1.38e6     10.6  7.03e-11     7
 8 Michigan   … TSLM(Ne…    0.0974        0.0829 6.85e6      6.74 8.51e- 7     7
 9 Mississippi… TSLM(Ne…    0.0556        0.0405 4.29e5      3.68 1.45e- 3     7
10 Rhode Islan… TSLM(Ne…    0.214         0.202  2.83e5     17.0  2.01e-17     7
11 Texas      … TSLM(Ne…    0.0340        0.0185 4.60e7      2.20 4.24e- 2     7
12 Washington … TSLM(Ne…    0.0657        0.0507 8.82e5      4.39 2.63e- 4     7
# … with 8 more variables: log_lik &lt;dbl&gt;, AIC &lt;dbl&gt;, AICc &lt;dbl&gt;, BIC &lt;dbl&gt;,
#   CV &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;, rank &lt;int&gt;</code></pre>
<p>In 12 states, there appear to be and in a few of them, those effects are large. Modelling this covariate seems useful. At the same time, this does nothing about the broad trends.</p>
</div>
<div id="training-and-testing" class="section level2">
<h2>Training and Testing</h2>
<p>That gives me the data that I want; now let me slice it up into training and test sets.</p>
<pre class="r"><code>COVID.Agg.Test &lt;- NYTAgg.COVID %&gt;%
    as_tibble() %&gt;%
    group_by(state) %&gt;%
    slice_tail(n = 14) %&gt;%
    ungroup() %&gt;%
    as_tsibble(index = date, key = state)
COVID.Agg.Train &lt;- anti_join(NYTAgg.COVID, COVID.Agg.Test) %&gt;%
    as_tsibble(index = date, key = state)</code></pre>
</div>
<div id="model-fitting" class="section level2">
<h2>Model Fitting</h2>
<p>Fit some models to the data.</p>
<pre class="r"><code>COVID.Models &lt;- COVID.Agg.Train %&gt;%
    model(WDARIMA = ARIMA(New.CasesP ~ Day.of.Week))</code></pre>
<p>Forecast the models.</p>
<pre class="r"><code>COVIDFC &lt;- COVID.Models %&gt;%
    forecast(new_data = COVID.Agg.Test)
COVIDFC %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 52 x 11
   .model  state            .type      ME   RMSE   MAE     MPE  MAPE  MASE RMSSE
   &lt;chr&gt;   &lt;chr*&gt;           &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 WDARIMA Alabama        … Test   116.    398.  237.   -10.3   71.8   NaN   NaN
 2 WDARIMA Alaska         … Test   -17.6   138.  104.  -Inf    Inf     NaN   NaN
 3 WDARIMA Arizona        … Test    94.2   354.  312.    11.3   51.8   NaN   NaN
 4 WDARIMA Arkansas       … Test    95.5   121.   99.2   93.0   94.9   NaN   NaN
 5 WDARIMA California     … Test  -108.    737.  569.    -8.18  20.7   NaN   NaN
 6 WDARIMA Colorado       … Test   308.    579.  480.    10.8   28.6   NaN   NaN
 7 WDARIMA Connecticut    … Test  -332.    456.  400.  -Inf    Inf     NaN   NaN
 8 WDARIMA Delaware       … Test   -39.4    64.5  48.6  -16.8   19.1   NaN   NaN
 9 WDARIMA District of Col… Test    -8.87   33.1  26.0  -14.8   24.1   NaN   NaN
10 WDARIMA Florida        … Test   352.   1367.  963.    -6.17  23.2   NaN   NaN
# … with 42 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Look at the aggregates.</p>
<pre class="r"><code>COVIDFC %&gt;%
    filter(is_aggregated(state)) %&gt;%
    autoplot(NYTAgg.COVID %&gt;%
        filter(date &gt; as.Date(&quot;2021-03-01&quot;)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/AggFD-1.png" width="672" /></p>
<p>Look at Oregon.</p>
<pre class="r"><code>COVIDFC %&gt;%
    filter(state == &quot;Oregon&quot;) %&gt;%
    autoplot(NYTAgg.COVID %&gt;%
        filter(date &gt; as.Date(&quot;2021-03-01&quot;)))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/OreFD-1.png" width="672" /></p>
</div>
<div id="prophet" class="section level2">
<h2>Prophet</h2>
<pre class="r"><code>library(prophet)
ProphMod &lt;- prophet::prophet(NYT.COVID %&gt;%
    filter(state == &quot;Oregon&quot;) %&gt;%
    select(ds = date, y = cases))
future &lt;- make_future_dataframe(ProphMod, periods = 30)
forecast &lt;- predict(ProphMod, future)
plot(ProphMod, forecast) + labs(x = &quot;Date&quot;, y = &quot;COVID-19 Cases&quot;, title = &quot;COVID-19 Forecast for Oregon: Using Prophet&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/ProphetFC-1.png" width="672" /></p>
<pre class="r"><code>prophet_plot_components(ProphMod, forecast)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/ProphetFC-2.png" width="672" /></p>
</div>
<div id="oregon" class="section level2">
<h2>Oregon</h2>
<pre class="r"><code>Oregon.C19 &lt;- NYTAgg.COVID %&gt;%
    filter(state == &quot;Oregon&quot;)
Oregon.C19 %&gt;%
    features(cases, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      6.08        0.01    3.99       0.1      2       0</code></pre>
<pre class="r"><code>Oregon.C19 %&gt;%
    features(deaths, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      5.98        0.01    3.59       0.1      2       0</code></pre>
<pre class="r"><code>Oregon.C19 %&lt;&gt;%
    mutate(New.Cases = difference(cases), New.Deaths = difference(deaths))</code></pre>
<pre class="r"><code># Visualize the differenced series
Oregon.C19 %&gt;%
    autoplot(New.Cases)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>Oregon.C19 %&gt;%
    autoplot(New.Deaths)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<pre class="r"><code># The Features of the Differenced Series
Oregon.C19 %&gt;%
    features(New.Cases, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      2.73        0.01   -3.38    0.0147      1       0</code></pre>
<pre class="r"><code>Oregon.C19 %&gt;%
    features(New.Deaths, features = list(unitroot_kpss, unitroot_pp, unitroot_ndiffs, 
        unitroot_nsdiffs))</code></pre>
<pre><code># A tibble: 1 x 7
  state  kpss_stat kpss_pvalue pp_stat pp_pvalue ndiffs nsdiffs
  &lt;chr*&gt;     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;
1 Oregon      2.21        0.01   -10.8      0.01      1       0</code></pre>
</div>
<div id="decompositions" class="section level2">
<h2>Decompositions</h2>
<pre class="r"><code># Classical decomposition
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;additive&quot;)) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;multiplicative&quot;)) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-2.png" width="672" /></p>
<div id="cases" class="section level3">
<h3>Cases</h3>
<pre class="r"><code># Show the seasonally adjusted data
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;additive&quot;)) %&gt;%
    components() %&gt;%
    select(season_adjust) %&gt;%
    autoplot(season_adjust, alpha = 0.2) + geom_line(data = Oregon.C19, aes(x = date, 
    y = New.Cases), color = &quot;red&quot;, alpha = 0.2) + theme_ipsum_es() + labs(title = &quot;Seasonally Adjusted (Add) New Covid-19 Cases&quot;, 
    y = &quot;New Covid-19 Cases&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="deaths" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-03-01&quot;)) %&gt;%
    model(classical_decomposition(New.Cases, type = &quot;multiplicative&quot;)) %&gt;%
    components() %&gt;%
    select(season_adjust) %&gt;%
    autoplot(season_adjust, alpha = 0.2) + geom_line(data = Oregon.C19, aes(x = date, 
    y = New.Cases), color = &quot;red&quot;, alpha = 0.2) + theme_ipsum_es() + labs(title = &quot;Seasonally Adjusted (Mult) New Covid-19 Cases&quot;, 
    y = &quot;New Covid-19 Cases&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<div id="stl" class="section level2">
<h2>STL</h2>
<p>The STL decomposition is a very useful tool.</p>
<div id="cases-1" class="section level3">
<h3>Cases</h3>
<pre class="r"><code># STL: Things are actually worse than the Fall....
Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(STL(New.Cases ~ trend(window = 14) + season(period = &quot;1 week&quot;))) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/STL1-1.png" width="672" /></p>
<pre class="r"><code># The three peaks are interesting and we seem to be headed for a fourth that is
# already worse than the first.</code></pre>
</div>
<div id="deaths-1" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(STL(New.Deaths ~ trend(window = 14) + season(period = &quot;1 week&quot;))) %&gt;%
    components() %&gt;%
    autoplot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code># Deaths are far more rare and the peaks are less noticeable.</code></pre>
<p>What follows works off of the data with the zeroes removed.</p>
</div>
</div>
<div id="some-models" class="section level2">
<h2>Some Models</h2>
<pre class="r"><code>OC19 &lt;- Oregon.C19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;))
fitC &lt;- OC19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.CasesP ~ fourier(K = 1)), `K = 2` = ARIMA(New.CasesP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.CasesP ~ fourier(K = 3)), ARIMA = ARIMA(New.CasesP), 
        ETS = ETS(New.CasesP))
fitC %&gt;%
    glance()</code></pre>
<pre><code># A tibble: 5 x 12
  state  .model sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots      MSE
  &lt;chr*&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;      &lt;dbl&gt;
1 Oregon K = 1  22694.  -2443. 4898. 4898. 4921. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
2 Oregon K = 2  22637.  -2441. 4899. 4899. 4930. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
3 Oregon K = 3  22731.  -2441. 4902. 4903. 4941. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
4 Oregon ARIMA  24605.  -2459. 4927. 4927. 4942. &lt;cpl [0]&gt; &lt;cpl [15]&gt;    NA 
5 Oregon ETS    22934.  -3040. 6100. 6101. 6140. &lt;NULL&gt;    &lt;NULL&gt;     22392.
# … with 2 more variables: AMSE &lt;dbl&gt;, MAE &lt;dbl&gt;</code></pre>
<pre class="r"><code># The best fit is K=2
fitC %&gt;%
    select(`K = 2`) %&gt;%
    forecast() %&gt;%
    autoplot() + autolayer(Oregon.C19 %&gt;%
    select(New.CasesP) %&gt;%
    filter(date &gt; as.Date(&quot;2021-02-01&quot;))) + theme_ipsum_rc() + labs(title = &quot;Harmonic Regression ARIMA Forecast of New COVID-19 Cases in Oregon&quot;) + 
    geom_point(aes(x = as.Date(&quot;2021-04-08&quot;), y = 678), size = 5) + geom_label(data = data.frame(x = as.Date(&quot;2021-03-31&quot;), 
    y = 736.446456504249, label = &quot;Oregon&#39;s Case Count for 4/8/2021&quot;), mapping = aes(x = x, 
    y = y, label = label), label.padding = unit(0.25, &quot;lines&quot;), label.r = unit(0.15, 
    &quot;lines&quot;), inherit.aes = FALSE)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div id="deaths-2" class="section level3">
<h3>Deaths</h3>
<pre class="r"><code>fitD &lt;- OC19 %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.DeathsP ~ fourier(K = 1)), `K = 2` = ARIMA(New.DeathsP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.DeathsP ~ fourier(K = 3)), ARIMA = ARIMA(New.DeathsP), 
        ETS = ETS(New.DeathsP))
fitD %&gt;%
    glance()</code></pre>
<pre><code># A tibble: 5 x 12
  state  .model sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots    MSE
  &lt;chr*&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;    &lt;dbl&gt;
1 Oregon K = 1    35.0  -1213. 2440. 2441. 2468. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
2 Oregon K = 2    34.6  -1210. 2437. 2438. 2472. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
3 Oregon K = 3    34.7  -1209. 2440. 2441. 2484. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
4 Oregon ARIMA    35.2  -1216. 2441. 2441. 2461. &lt;cpl [8]&gt; &lt;cpl [8]&gt;  NA  
5 Oregon ETS      38.6  -1824. 3667. 3668. 3707. &lt;NULL&gt;    &lt;NULL&gt;     37.7
# … with 2 more variables: AMSE &lt;dbl&gt;, MAE &lt;dbl&gt;</code></pre>
</div>
</div>
<div id="a-bigger-set-of-models-and-reconciliation" class="section level2">
<h2>A Bigger Set of Models and Reconciliation</h2>
<pre class="r"><code>NC.Models &lt;- COVID.Agg.Train %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.CasesP ~ fourier(K = 1)), `K = 2` = ARIMA(New.CasesP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.CasesP ~ fourier(K = 3)), ARIMA = ARIMA(New.CasesP), 
        ETS = ETS(New.CasesP), NNET = NNETAR(New.CasesP ~ fourier(K = 2, period = &quot;1 week&quot;))) %&gt;%
    mutate(Combo1 = (`K = 2` + ARIMA + ETS)/3, Combo2 = (`K = 2` + ARIMA + ETS + 
        NNET)/4) %&gt;%
    reconcile(buARIMA = bottom_up(ARIMA), buK2 = bottom_up(`K = 2`), buETS = bottom_up(ETS), 
        buNN = bottom_up(NNET))</code></pre>
</div>
<div id="accuracy" class="section level2">
<h2>Accuracy</h2>
<pre class="r"><code>FC.Cases &lt;- NC.Models %&gt;%
    forecast(h = 14)</code></pre>
<pre class="r"><code>FC.Cases %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 624 x 11
   .model state            .type      ME   RMSE    MAE     MPE  MAPE  MASE RMSSE
   &lt;chr&gt;  &lt;chr*&gt;           &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 ARIMA  Alabama        … Test   101.    439.   277.   -32.5   95.4   NaN   NaN
 2 ARIMA  Alaska         … Test   -43.0   147.   115.  -Inf    Inf     NaN   NaN
 3 ARIMA  Arizona        … Test   -51.6   212.   160.   -16.7   26.4   NaN   NaN
 4 ARIMA  Arkansas       … Test     8.19   67.8   57.7  -24.0   51.8   NaN   NaN
 5 ARIMA  California     … Test  -415.    685.   586.   -20.3   24.8   NaN   NaN
 6 ARIMA  Colorado       … Test    83.8   529.   458.    -5.56  31.9   NaN   NaN
 7 ARIMA  Connecticut    … Test  -176.    370.   305.  -Inf    Inf     NaN   NaN
 8 ARIMA  Delaware       … Test    -5.35   55.4   47.8   -6.35  17.2   NaN   NaN
 9 ARIMA  District of Col… Test   -13.2    37.3   31.6  -20.6   30.6   NaN   NaN
10 ARIMA  Florida        … Test   145.   1484.  1069.   -13.8   29.2   NaN   NaN
# … with 614 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Assess the models over the units.</p>
<pre class="r"><code>FC.Cases %&gt;%
    accuracy(COVID.Agg.Test) %&gt;%
    group_by(state) %&gt;%
    slice_min(MAE) %&gt;%
    janitor::tabyl(.model) %&gt;%
    ggplot(aes(x = .model, y = n)) + geom_col() + theme_ipsum_rc()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="deaths-3" class="section level1">
<h1>Deaths</h1>
<pre class="r"><code>ND.Models &lt;- COVID.Agg.Train %&gt;%
    filter(date &gt; as.Date(&quot;2020-04-01&quot;)) %&gt;%
    model(`K = 1` = ARIMA(New.DeathsP ~ fourier(K = 1)), `K = 2` = ARIMA(New.DeathsP ~ 
        fourier(K = 2)), `K = 3` = ARIMA(New.DeathsP ~ fourier(K = 3)), ARIMA = ARIMA(New.DeathsP), 
        ETS = ETS(New.DeathsP), NNET = NNETAR(New.DeathsP ~ fourier(K = 2, period = &quot;1 week&quot;))) %&gt;%
    mutate(Combo1 = (`K = 2` + ARIMA + ETS)/3, Combo2 = (`K = 2` + ARIMA + ETS + 
        NNET)/4) %&gt;%
    reconcile(buARIMA = bottom_up(ARIMA), buK2 = bottom_up(`K = 2`), buETS = bottom_up(ETS), 
        buNN = bottom_up(NNET))</code></pre>
<div id="accuracy-1" class="section level2">
<h2>Accuracy</h2>
<pre class="r"><code>FC.Deaths &lt;- ND.Models %&gt;%
    forecast(h = 14)</code></pre>
<pre class="r"><code>FC.Deaths %&gt;%
    accuracy(COVID.Agg.Test)</code></pre>
<pre><code># A tibble: 624 x 11
   .model state            .type      ME   RMSE    MAE     MPE  MAPE  MASE RMSSE
   &lt;chr&gt;  &lt;chr*&gt;           &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 ARIMA  Alabama        … Test    1.74  12.4   10.7    NaN    Inf     NaN   NaN
 2 ARIMA  Alaska         … Test    0.888  4.86   1.86  -Inf    Inf     NaN   NaN
 3 ARIMA  Arizona        … Test   10.1   17.1   14.9    Inf    Inf     NaN   NaN
 4 ARIMA  Arkansas       … Test   -4.84   5.55   4.84  -Inf    Inf     NaN   NaN
 5 ARIMA  California     … Test   -3.21  31.8   22.2     -7.51  23.4   NaN   NaN
 6 ARIMA  Colorado       … Test    7.81  26.1    9.19  -Inf    Inf     NaN   NaN
 7 ARIMA  Connecticut    … Test    2.64   5.61   4.11   NaN    Inf     NaN   NaN
 8 ARIMA  Delaware       … Test   -1.64   2.55   2.10  -Inf    Inf     NaN   NaN
 9 ARIMA  District of Col… Test   -0.368  0.947  0.697 -Inf    Inf     NaN   NaN
10 ARIMA  Florida        … Test  -12.3   18.9   15.8    -66.1   70.2   NaN   NaN
# … with 614 more rows, and 1 more variable: ACF1 &lt;dbl&gt;</code></pre>
<p>Assess the models over the units.</p>
<pre class="r"><code>FC.Deaths %&gt;%
    accuracy(COVID.Agg.Test) %&gt;%
    group_by(state) %&gt;%
    slice_min(MAE) %&gt;%
    janitor::tabyl(.model) %&gt;%
    ggplot(aes(x = .model, y = n)) + geom_col() + theme_ipsum_rc()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
</div>
